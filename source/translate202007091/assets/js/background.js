define(function(require){var o=require("components/ArrayBufferPlayer");require("lib/idbstore");var e,r=require("components/cache"),s=require("components/debug"),u=((e=new XMLHttpRequest).open("GET","/manifest.json",!1),e.send(),JSON.parse(e.responseText).version);function a(){return window.external&&external.lego&&external.lego.browser&&external.lego.browser.Popup&&external.lego.browser.Popup('{"popup":"0"}')}function i(e,t,n){var o,r,a,s="&translateVersion="+u;if("object"==typeof n)for(var i in n)s+="&"+i+"="+encodeURIComponent(n[i]);else s+="&value="+encodeURIComponent(n);external.lego?(o=e,r=t,a=s,window.external&&external.lego&&(external.lego.Report?external.lego.Report(o,r,a):external.lego.Common.Report(o,r,a))):console.log(e,t,s)}var c,l=require("lib/storage");l.getItem("settings")||l.setItem("settings",JSON.stringify({openSelected:!0,openPage:!0})),i(132,4,l.getItem("settings")),c={1:"aapbdbdomjkkjkaonfhkkikfgjllcleb",2:"fcihnniakiicgonogcieldhhjbgpnjpj",3:"eopjamdnofihpioajgfdikhhbobonhbb",4:"cngicmmkocjjbmacacmchjhdimdhfgod",5:"njeebknkghnjbobnghdlfgfaigkjciih",6:"nbdnlnijofenjgknplpelkpmhikpangb"},chrome.management.getAll(function(e){for(var t,n=Object.keys(c),o=[],r=e.length-1;0<=r;r--)for(t=n.length-1;0<=t;t--)e[r].id==c[n[t]]&&o.push(n[t]);i(132,1,o.length?o.join(""):"0")}),chrome.webRequest.onCompleted.addListener(function(e){!l.getItem("guide1Showed")&&external&&external.lego&&(chrome.browserAction.setPopup({popup:"guide1.html"}),a());for(var t=e.url.match(/http:\/\/(.*?)\//)[1],n={0:/dict\.youdao\.com/,1:/iciba\.com/,2:/translate\.google\.cn/,3:/fanyi\.baidu\.com/,4:/dict\.cn/,5:/fanyi\.youdao\.com/},o=Object.keys(n),r=o.length-1;0<=r;r--)n[o[r]].test(t)&&i(132,0,o[r])},{urls:["http://dict.youdao.com/*","http://*.iciba.com/*","http://translate.google.cn/*","http://fanyi.baidu.com/*","http://*.dict.cn/*","http://fanyi.youdao.com/*"],types:["main_frame"]});var t=require("components/dict");function n(o,r){chrome.runtime.onMessage.addListener(function(e,t,n){return t.id===chrome.runtime.id&&e.type==o&&r(e,n,t),!0})}function p(n,o,r){var a=/[\u3040-\u30FF]/.test(n.value)?"2":/[\u4E00-\u9FA5]/.test(n.value)?"0":"1";t(n.value,function(e,t){o({type:"queryResponse",value:{result:e,poweredBy:t}}),r?i(132,2,{value:"1",la:a}):n.isShowDetails||i(132,3,{value:"1",la:a,value2:n.auto?1:2})},function(e){o({type:"queryResponse",value:{result:e}}),r?i(132,2,{value:"0",la:a}):n.isShowDetails||i(132,3,{value:"0",la:a,value2:n.auto?1:2})})}n("isPlayable",function(e,t){return r.get(e.key,e.url,function(e){t(null!==e)}),1});var g=!0,d="";n("play",function(e,t,n){return d===e.key?g?(g=!1,o.replay(function(){t(g=!0)})):t(!1):(d=e.key,r.getArrayBuffer(e.key,e.url,function(e){null!==e?(g=!1,o.play(e,function(){t(g=!0)})):(d="",t(!1))})),1});var h=!1;n("showDetails",function(e){h=e.query,console.log("show",h),chrome.browserAction.setPopup({popup:"popup.html"}),a()}),n("isShowDetails",function(e,t){console.log("isShow",h),t(h),h=!1}),n("query",function(e,t,n){p(e,t,!0)}),n("queryFromPopup",function(e,t,n){p(e,t,!1)}),n("settings",function(e,t){switch(e.value.method){case"get":t({type:"settingsResponse",value:JSON.parse(l.getItem("settings")||"{}")});break;case"set":var n=JSON.parse(l.getItem("settings")||"{}");n.openSelected=e.value.data.openSelected,l.setItem("settings",JSON.stringify(n)),"tip"==e.source&&external&&external.lego&&(chrome.browserAction.setPopup({popup:"guide2.html"}),a()),t({type:"settingsResponse",value:n})}}),n("ignore",function(e,t){var n=JSON.parse(l.getItem("ignoreHost")||"[]");n.push(e.value),l.setItem("ignoreHost",JSON.stringify(n)),t({statue:"ok"})}),n("stat",function(e){i(132,e.value.type,e.value.data)}),n("completed",function(e){chrome.browserAction.setPopup({popup:"popup.html"}),"guide1"==e.value?(l.setItem("guide1Showed",(new Date).getTime()),i(132,7,"0")):"guide2"==e.value&&i(132,8,"0")}),n("queryFromGuide1",function(e){i(132,7,"1")}),n("queryFromGuide2",function(e){i(132,8,"1")}),n("language",function(e,t,n){chrome.tabs.detectLanguage(n.tab.id,function(e){t(e)})});var f=document.createElement("a");function m(e){return f.href=e,{host:f.host,hostname:f.hostname,pathname:f.pathname,protocal:f.protocal,search:f.search}}function v(e){var t=e.match(/(?:[^.]+\.)?[^.]+$/);return t&&0<t.length?t[0]:e}var b=Object.create(null),y=localStorage.persistentHasTranslated,w=Object.create(null);function _(e){var t=e.id,n=e.url;if(n){if(s.test(n),!(/^https?:/.test(n)&&-1===n.indexOf("store.liebao.cn")))return;if(["lego_api","lego_kQuery","lego_ext"].forEach(function(e){chrome.tabs.executeScript(t,{file:"assets/js/lib/"+e+".js",runAt:"document_start"})}),chrome.tabs.executeScript(t,{file:"content.js",runAt:"document_start"}),!0!==JSON.parse(l.getItem("settings")||"{}").openPage)return;for(var o=JSON.parse(l.getItem("ignoreHost")||"[]"),r=n.match(/^(?:(\w+):\/\/)?(?:(\w+):?(\w+)?@)?([^:\/\?#]+)(?::(\d+))?(\/[^\?#]+)?(?:\?([^#]+))?(?:#(\w+))?/),a=o.length-1;0<=a;a--)if(r[4]==o[a])return;chrome.tabs.executeScript(t,{file:"pageTranslate.js",runAt:"document_start"})}}function k(){var e=this;e._destroyed=!1,e._token=0;var o=e._listeners=Object.create(null);e._listenerCount=0;var t=e._worker=new Worker("htmlTextWorker.js");e._onMessage=function(e){var t,n=e.data;n&&(t=n.token)&&t in o?(--this._listenerCount,o[t](n.counter),delete o[t]):window.console.log(n)},t.addEventListener("message",e._onMessage,!1)}n("isShowInfoBar",function(e,t,n){var o,r;n.tab&&n.tab.url&&(r=v(o=m(n.tab.url).hostname),y||(o in b?0<b[o]?b[o]=b[o]-1:(0===b[o]&&(b[o]=-1,i(132,9,o)),t({showInfoBar:!1,action:w[r]})):b[o]=2),t({showInfoBar:!0,action:w[r]}))}),n("action",function(e,t,n){var o=m(n.tab.url).hostname;y=y||(localStorage.persistentHasTranslated=1);var r=v(o);w[r]=e.action}),n("return",function(e,t,n){var o=m(n.tab.url).hostname;o in b&&(b[o]=3);var r=v(o);r in w&&(w[r]=!1)}),chrome.tabs.query({},function(e){e.forEach(_)}),chrome.tabs.onUpdated.addListener(function(e,t,n){"loading"===t.status&&_(n)});var j=k.prototype;j.countText=function(e,t){if(this._destroyed)throw"Worker has been destroyed";var n=this._getToken(),o=!1;this._listeners[n]=function(e){o||(o=!0,t(e))},this._worker.postMessage({token:n,html:e})},j._getToken=function(){if(this._destroyed)throw"Worker has been destroyed";var e=this._token;return e===++e&&(e=0),this._token=e},j._destroy=function(){var e=this;if(e._destroyed)throw"Worker has been destroyed";e._destroyed=!0;var t=e._worker;if(t.removeEventListener("message",e._onMessage,!1),t.terminate(),0!==e._listenerCount){var n=e._listeners;for(var o in n)n[o](null),delete n[o]}},k._instance=null,k._to=null,k.getInstance=function(){clearTimeout(k._to),k._to=setTimeout(function(){var e=k._instance;e._destroyed||0!==e._listenerCount||e._destroy()},15e3);var e=k._instance;return e&&!e._destroyed?e:e=k._instance=new k},n("countText",function(e,t,n){return k.getInstance().countText(e.html,t),1})});
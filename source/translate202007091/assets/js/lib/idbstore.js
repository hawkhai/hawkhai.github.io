define(function(){"use strict";function l(e){throw e}function e(e,t){for(var r in void 0===t&&"function"==typeof e&&(t=e),"[object Object]"!=Object.prototype.toString.call(e)&&(e={}),o)this[r]=void 0!==e[r]?e[r]:o[r];this.dbName=this.storePrefix+this.storeName,this.dbVersion=parseInt(this.dbVersion,10)||1,t&&(this.onStoreReady=t);var n="object"==typeof window?window:self;this.idb=n.indexedDB||n.webkitIndexedDB||n.mozIndexedDB,this.keyRange=n.IDBKeyRange||n.webkitIDBKeyRange||n.mozIDBKeyRange,this.features={hasAutoIncrement:!n.mozIndexedDB},this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"},this.openDB()}var o={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:l,indexes:[]};e.prototype={constructor:e,version:"1.4.1",db:null,dbName:null,dbVersion:null,store:null,storeName:null,keyPath:null,autoIncrement:null,indexes:null,features:null,onStoreReady:null,onError:null,_insertIdCount:0,openDB:function(){var e=this.idb.open(this.dbName,this.dbVersion),o=!1;e.onerror=function(e){var t=!1;"error"in e.target?t="VersionError"==e.target.error.name:"errorCode"in e.target&&(t=12==e.target.errorCode),t?this.onError(new Error("The version number provided is lower than the existing one.")):this.onError(e)}.bind(this),e.onsuccess=function(e){var t,n;o||(this.db?this.onStoreReady():(this.db=e.target.result,"string"!=typeof this.db.version?this.db.objectStoreNames.contains(this.storeName)?(t=this.db.transaction([this.storeName],this.consts.READ_ONLY),this.store=t.objectStore(this.storeName),n=Array.prototype.slice.call(this.getIndexList()),this.indexes.forEach(function(e){var t,r=e.name;if(!r)return o=!0,void this.onError(new Error("Cannot create index: No index name given."));this.normalizeIndexData(e),this.hasIndex(r)?(t=this.store.index(r),this.indexComplies(t,e)||(o=!0,this.onError(new Error('Cannot modify index "'+r+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),n.splice(n.indexOf(r),1)):(o=!0,this.onError(new Error('Cannot create new index "'+r+'" for current version. Please bump version number to '+(this.dbVersion+1)+".")))},this),n.length&&(o=!0,this.onError(new Error('Cannot delete index(es) "'+n.toString()+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),o||this.onStoreReady()):this.onError(new Error("Something is wrong with the IndexedDB implementation in this browser. Please upgrade your browser.")):this.onError(new Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."))))}.bind(this),e.onupgradeneeded=function(e){var t;this.db=e.target.result,this.db.objectStoreNames.contains(this.storeName)?this.store=e.target.transaction.objectStore(this.storeName):(t={autoIncrement:this.autoIncrement},null!==this.keyPath&&(t.keyPath=this.keyPath),this.store=this.db.createObjectStore(this.storeName,t));var n=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(e){var t,r=e.name;r||(o=!0,this.onError(new Error("Cannot create index: No index name given."))),this.normalizeIndexData(e),this.hasIndex(r)?(t=this.store.index(r),this.indexComplies(t,e)||(this.store.deleteIndex(r),this.store.createIndex(r,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})),n.splice(n.indexOf(r),1)):this.store.createIndex(r,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})},this),n.length&&n.forEach(function(e){this.store.deleteIndex(e)},this)}.bind(this)},deleteDatabase:function(){this.idb.deleteDatabase&&this.idb.deleteDatabase(this.dbName)},put:function(e,t,r,n){null!==this.keyPath&&(n=r,r=t,t=e),n=n||l,r=r||d;var o,i=!1,s=null,a=this.db.transaction([this.storeName],this.consts.READ_WRITE);return a.oncomplete=function(){(i?r:n)(s)},a.onabort=n,a.onerror=n,(o=null!==this.keyPath?(this._addIdPropertyIfNeeded(t),a.objectStore(this.storeName).put(t)):a.objectStore(this.storeName).put(t,e)).onsuccess=function(e){i=!0,s=e.target.result},o.onerror=n,a},get:function(e,t,r){r=r||l,t=t||d;var n=!1,o=null,i=this.db.transaction([this.storeName],this.consts.READ_ONLY);i.oncomplete=function(){(n?t:r)(o)},i.onabort=r,i.onerror=r;var s=i.objectStore(this.storeName).get(e);return s.onsuccess=function(e){n=!0,o=e.target.result},s.onerror=r,i},remove:function(e,t,r){r=r||l,t=t||d;var n=!1,o=null,i=this.db.transaction([this.storeName],this.consts.READ_WRITE);i.oncomplete=function(){(n?t:r)(o)},i.onabort=r,i.onerror=r;var s=i.objectStore(this.storeName).delete(e);return s.onsuccess=function(e){n=!0,o=e.target.result},s.onerror=r,i},batch:function(e,t,a){a=a||l,t=t||d,"[object Array]"!=Object.prototype.toString.call(e)&&a(new Error("dataArray argument must be of type Array."));var u=this.db.transaction([this.storeName],this.consts.READ_WRITE);u.oncomplete=function(){(n?t:a)(n)},u.onabort=a,u.onerror=a;function c(){0!==--r||h||(n=h=!0)}var r=e.length,h=!1,n=!1;return e.forEach(function(e){function t(e){u.abort(),h||(h=!0,a(e,o,i))}var r,n,o=e.type,i=e.key,s=e.value;"remove"==o?((r=u.objectStore(this.storeName).delete(i)).onsuccess=c,r.onerror=t):"put"==o&&((n=null!==this.keyPath?(this._addIdPropertyIfNeeded(s),u.objectStore(this.storeName).put(s)):u.objectStore(this.storeName).put(s,i)).onsuccess=c,n.onerror=t)},this),u},putBatch:function(e,t,r){var n=e.map(function(e){return{type:"put",value:e}});return this.batch(n,t,r)},removeBatch:function(e,t,r){var n=e.map(function(e){return{type:"remove",key:e}});return this.batch(n,t,r)},getBatch:function(e,t,r,n){r=r||l,t=t||d,n=n||"sparse","[object Array]"!=Object.prototype.toString.call(e)&&r(new Error("keyArray argument must be of type Array."));var o=this.db.transaction([this.storeName],this.consts.READ_ONLY);o.oncomplete=function(){(u?t:r)(c)},o.onabort=r,o.onerror=r;function i(e){e.target.result||"dense"==n?s.push(e.target.result):"sparse"==n&&s.length++,0===--a&&(u=!0,c=s)}var s=[],a=e.length,u=!1,c=null;return e.forEach(function(e){var t=o.objectStore(this.storeName).get(e);t.onsuccess=i,t.onerror=function(e){r(c=e),o.abort()}},this),o},getAll:function(e,t){t=t||l,e=e||d;var r=this.db.transaction([this.storeName],this.consts.READ_ONLY),n=r.objectStore(this.storeName);return n.getAll?this._getAllNative(r,n,e,t):this._getAllCursor(r,n,e,t),r},_getAllNative:function(e,t,r,n){var o=!1,i=null;e.oncomplete=function(){(o?r:n)(i)},e.onabort=n,e.onerror=n;var s=t.getAll();s.onsuccess=function(e){o=!0,i=e.target.result},s.onerror=n},_getAllCursor:function(e,t,r,n){var o=[],i=!1,s=null;e.oncomplete=function(){(i?r:n)(s)},e.onabort=n,e.onerror=n;var a=t.openCursor();a.onsuccess=function(e){var t=e.target.result;t?(o.push(t.value),t.continue()):(i=!0,s=o)},a.onError=n},clear:function(e,t){t=t||l,e=e||d;var r=!1,n=null,o=this.db.transaction([this.storeName],this.consts.READ_WRITE);o.oncomplete=function(){(r?e:t)(n)},o.onabort=t,o.onerror=t;var i=o.objectStore(this.storeName).clear();return i.onsuccess=function(e){r=!0,n=e.target.result},i.onerror=t,o},_addIdPropertyIfNeeded:function(e){this.features.hasAutoIncrement||void 0!==e[this.keyPath]||(e[this.keyPath]=this._insertIdCount+++Date.now())},getIndexList:function(){return this.store.indexNames},hasIndex:function(e){return this.store.indexNames.contains(e)},normalizeIndexData:function(e){e.keyPath=e.keyPath||e.name,e.unique=!!e.unique,e.multiEntry=!!e.multiEntry},indexComplies:function(i,s){return["keyPath","unique","multiEntry"].every(function(e){if("multiEntry"==e&&void 0===i[e]&&!1===s[e])return!0;if("keyPath"!=e||"[object Array]"!=Object.prototype.toString.call(s[e]))return s[e]==i[e];var t=s.keyPath,r=i.keyPath;if("string"==typeof r)return t.toString()==r;if("function"!=typeof r.contains&&"function"!=typeof r.indexOf)return!1;if(r.length!==t.length)return!1;for(var n=0,o=t.length;n<o;n++)if(!(r.contains&&r.contains(t[n])||r.indexOf(-1!==t[n])))return!1;return!0})},iterate:function(r,n){var e="desc"==(n=u({index:null,order:"ASC",autoContinue:!0,filterDuplicates:!1,keyRange:null,writeAccess:!1,onEnd:null,onError:l},n||{})).order.toLowerCase()?"PREV":"NEXT";n.filterDuplicates&&(e+="_NO_DUPLICATE");var o=!1,i=this.db.transaction([this.storeName],this.consts[n.writeAccess?"READ_WRITE":"READ_ONLY"]),t=i.objectStore(this.storeName);n.index&&(t=t.index(n.index)),i.oncomplete=function(){o?n.onEnd?n.onEnd():r(null):n.onError(null)},i.onabort=n.onError,i.onerror=n.onError;var s=t.openCursor(n.keyRange,this.consts[e]);return s.onerror=n.onError,s.onsuccess=function(e){var t=e.target.result;t?(r(t.value,t,i),n.autoContinue&&t.continue()):o=!0},i},query:function(e,t){var r=[];return(t=t||{}).onEnd=function(){e(r)},this.iterate(function(e){r.push(e)},t)},count:function(e,t){var r=(t=u({index:null,keyRange:null},t||{})).onError||l,n=!1,o=null,i=this.db.transaction([this.storeName],this.consts.READ_ONLY);i.oncomplete=function(){(n?e:r)(o)},i.onabort=r,i.onerror=r;var s=i.objectStore(this.storeName);t.index&&(s=s.index(t.index));var a=s.count(t.keyRange);return a.onsuccess=function(e){n=!0,o=e.target.result},a.onError=r,i},makeKeyRange:function(e){var t,r=void 0!==e.lower,n=void 0!==e.upper;switch(!0){case void 0!==e.only:t=this.keyRange.only(e.only);break;case r&&n:t=this.keyRange.bound(e.lower,e.upper,e.excludeLower,e.excludeUpper);break;case r:t=this.keyRange.lowerBound(e.lower,e.excludeLower);break;case n:t=this.keyRange.upperBound(e.upper,e.excludeUpper);break;default:throw new Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value, or an "only" value.')}return t}};var d=function(){},i={},u=function(e,t){var r,n;for(r in t)(n=t[r])!==i[r]&&n!==e[r]&&(e[r]=n);return e};return e.version=e.prototype.version,e});

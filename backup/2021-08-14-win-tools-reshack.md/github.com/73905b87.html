---
title : 自动快照存档
---

* TIME: 2022-06-28 14:35:39
* URL: <https://github.com/pyinstaller/pyinstaller/blob/master/PyInstaller/utils/win32/winutils.py>

-----

Skip to content

[ ](https://github.com/)

[ Sign up
](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-
name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo)

  * Product 

    * [ Features ](/features)
    * [ Mobile ](/mobile)
    * [ Actions ](/features/actions)
    * [ Codespaces ](/features/codespaces)
    * [ Copilot ](/features/copilot)
    * [ Packages ](/features/packages)
    * [ Security ](/features/security)
    * [ Code review ](/features/code-review)
    * [ Issues ](/features/issues)
    * [ Integrations ](/features/integrations)
    * [ GitHub Sponsors ](/sponsors)
    * [ Customer stories ](/customer-stories)

  * [Team](/team)
  * [Enterprise](/enterprise)
  * Explore 

    * [ Explore GitHub ](/explore)
    * Learn and contribute
    * [ Topics ](/topics)
    * [ Collections ](/collections)
    * [ Trending ](/trending)
    * [ Skills ](https://skills.github.com/)
    * [ GitHub Sponsors ](/sponsors/explore)
    * [ Open source guides ](https://opensource.guide)
    * Connect with others
    * [ The ReadME Project ](/readme)
    * [ Events ](/events)
    * [ Community forum ](https://github.community)
    * [ GitHub Education ](https://education.github.com)
    * [ GitHub Stars program ](https://stars.github.com)

  * [Marketplace](/marketplace)
  * Pricing 

    * [ Plans ](/pricing)
    * [ Compare plans ](/pricing#compare-features)
    * [ Contact Sales ](https://github.com/enterprise/contact)
    * [ Education ](https://education.github.com)

  * [ ![]() In this repository  All GitHub  ↵ Jump to ↵ ]()

  * No suggested jump to results

  * [ ![]() In this repository  All GitHub  ↵ Jump to ↵ ]()
  * [ ![]() In this organization  All GitHub  ↵ Jump to ↵ ]()
  * [ ![]() In this repository  All GitHub  ↵ Jump to ↵ ]()

[ Sign in
](/login?return_to=https%3A%2F%2Fgithub.com%2Fpyinstaller%2Fpyinstaller%2Fblob%2Fmaster%2FPyInstaller%2Futils%2Fwin32%2Fwinutils.py)

[ Sign up
](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-
name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-
repo&source_repo=pyinstaller%2Fpyinstaller)

{{ message }}

[pyinstaller](/pyinstaller) / **[pyinstaller](/pyinstaller/pyinstaller) **
Public

  * [ Sponsor ](/sponsors/Legorooj)
  * [ Notifications ](/login?return_to=%2Fpyinstaller%2Fpyinstaller)
  * [ Fork 1.8k ](/login?return_to=%2Fpyinstaller%2Fpyinstaller)
  * [ Star  9.3k ](/login?return_to=%2Fpyinstaller%2Fpyinstaller)

  * [ Code ](/pyinstaller/pyinstaller/tree/master)
  * [ Issues 266 ](/pyinstaller/pyinstaller/issues)
  * [ Pull requests 16 ](/pyinstaller/pyinstaller/pulls)
  * [ Discussions ](/pyinstaller/pyinstaller/discussions)
  * [ Actions ](/pyinstaller/pyinstaller/actions)
  * [ Projects 1 ](/pyinstaller/pyinstaller/projects?type=beta)
  * [ Wiki ](/pyinstaller/pyinstaller/wiki)
  * [ Security 1 ](/pyinstaller/pyinstaller/security)
  * [ Insights ](/pyinstaller/pyinstaller/pulse)

More

  * [ Code ](/pyinstaller/pyinstaller/tree/master)
  * [ Issues ](/pyinstaller/pyinstaller/issues)
  * [ Pull requests ](/pyinstaller/pyinstaller/pulls)
  * [ Discussions ](/pyinstaller/pyinstaller/discussions)
  * [ Actions ](/pyinstaller/pyinstaller/actions)
  * [ Projects ](/pyinstaller/pyinstaller/projects?type=beta)
  * [ Wiki ](/pyinstaller/pyinstaller/wiki)
  * [ Security ](/pyinstaller/pyinstaller/security)
  * [ Insights ](/pyinstaller/pyinstaller/pulse)

[Permalink](/pyinstaller/pyinstaller/blob/bcb824c1ad2989855a5fc01d95e5fc693b2f0966/PyInstaller/utils/win32/winutils.py)

master

Switch branches/tags

Branches Tags

Could not load branches

Nothing to show

[ {{ refName }} default ](https://github.com/pyinstaller/pyinstaller/blob/{{
urlEncodedRefName }}/PyInstaller/utils/win32/winutils.py) [View all
branches](/pyinstaller/pyinstaller/branches)

Could not load tags

Nothing to show

[ {{ refName }} default ](https://github.com/pyinstaller/pyinstaller/blob/{{
urlEncodedRefName }}/PyInstaller/utils/win32/winutils.py)

[View all tags](/pyinstaller/pyinstaller/tags)

##
[pyinstaller](/pyinstaller/pyinstaller/tree/master)/[PyInstaller](/pyinstaller/pyinstaller/tree/master/PyInstaller)/[utils](/pyinstaller/pyinstaller/tree/master/PyInstaller/utils)/[win32](/pyinstaller/pyinstaller/tree/master/PyInstaller/utils/win32)/
**winutils.py** / Jump to

Code definitions

[ get_windows_dir Function
](/pyinstaller/pyinstaller/blob/master/PyInstaller/utils/win32/winutils.py#L28)
[ get_system_path Function
](/pyinstaller/pyinstaller/blob/master/PyInstaller/utils/win32/winutils.py#L40)
[ extend_system_path Function
](/pyinstaller/pyinstaller/blob/master/PyInstaller/utils/win32/winutils.py#L57)
[ import_pywin32_module Function
](/pyinstaller/pyinstaller/blob/master/PyInstaller/utils/win32/winutils.py#L71)
[ convert_dll_name_to_str Function
](/pyinstaller/pyinstaller/blob/master/PyInstaller/utils/win32/winutils.py#L145)
[ set_exe_checksum Function
](/pyinstaller/pyinstaller/blob/master/PyInstaller/utils/win32/winutils.py#L160)

Code navigation index up-to-date

[ Go to file ](/pyinstaller/pyinstaller/find/master)

  * [ Go to file T ](/pyinstaller/pyinstaller/find/master)
  * Go to line L
  * Go to definition R
  *   * Copy path 
  * Copy permalink

This commit does not belong to any branch on this repository, and may belong
to a fork outside of the repository.

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=48&v=4)](/bwoodsend)

[bwoodsend](/bwoodsend) [refactor: Use absolute imports
throughout.](/pyinstaller/pyinstaller/commit/bec61fc4f68adecc74f1f307c6972481d81fa05d
"refactor: Use absolute imports throughout.

Doing so makes it far easier to load a file's namespace and thereby debug

its contents in any IDE which *runs* a script by calling runpy in an

interactive console \(PyCharm's console, Pyzo, Spyder, ...\).

Similarly, when stuck without an IDE \(e.g. using Docker\), any namespace

can be quickly entered using `python -i PyInstaller/subpackage/module.py`.")

…

Latest commit
[bec61fc](/pyinstaller/pyinstaller/commit/bec61fc4f68adecc74f1f307c6972481d81fa05d)
on 9 May 2021 [ **History**
](/pyinstaller/pyinstaller/commits/master/PyInstaller/utils/win32/winutils.py)

    
    
    Doing so makes it far easier to load a file's namespace and thereby debug
    its contents in any IDE which *runs* a script by calling runpy in an
    interactive console (PyCharm's console, Pyzo, Spyder, ...).
    Similarly, when stuck without an IDE (e.g. using Docker), any namespace
    can be quickly entered using `python -i PyInstaller/subpackage/module.py`.

**8** contributors

###  Users who have contributed to this file

[ ![@htgoebel](https://avatars.githubusercontent.com/u/784161?s=48&v=4)
](/pyinstaller/pyinstaller/commits/master/PyInstaller/utils/win32/winutils.py?author=htgoebel)
[ ![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=48&v=4)
](/pyinstaller/pyinstaller/commits/master/PyInstaller/utils/win32/winutils.py?author=bwoodsend)
[ ![@ricard33](https://avatars.githubusercontent.com/u/1162576?s=48&v=4)
](/pyinstaller/pyinstaller/commits/master/PyInstaller/utils/win32/winutils.py?author=ricard33)
[ ![@matysek](https://avatars.githubusercontent.com/u/527280?s=48&v=4)
](/pyinstaller/pyinstaller/commits/master/PyInstaller/utils/win32/winutils.py?author=matysek)
[ ![@leycec](https://avatars.githubusercontent.com/u/217028?s=48&v=4)
](/pyinstaller/pyinstaller/commits/master/PyInstaller/utils/win32/winutils.py?author=leycec)
[ ![@Legorooj](https://avatars.githubusercontent.com/u/50370070?s=48&v=4)
](/pyinstaller/pyinstaller/commits/master/PyInstaller/utils/win32/winutils.py?author=Legorooj)
[ ![@virtuald](https://avatars.githubusercontent.com/u/567900?s=48&v=4)
](/pyinstaller/pyinstaller/commits/master/PyInstaller/utils/win32/winutils.py?author=virtuald)
[ ![@bjones1](https://avatars.githubusercontent.com/u/2125584?s=48&v=4)
](/pyinstaller/pyinstaller/commits/master/PyInstaller/utils/win32/winutils.py?author=bjones1)

171 lines (139 sloc)  5.49 KB

[ Raw
](/pyinstaller/pyinstaller/raw/master/PyInstaller/utils/win32/winutils.py) [
Blame
](https://github.com/pyinstaller/pyinstaller/blame/master/PyInstaller/utils/win32/winutils.py)

Edit this file

E

[ Open in GitHub Desktop ](https://desktop.github.com)

  * [ Open with Desktop ](https://desktop.github.com)
  * [ View raw ](/pyinstaller/pyinstaller/raw/master/PyInstaller/utils/win32/winutils.py)
  * Copy raw contents  Copy raw contents  Copy raw contents  Copy raw contents 
  * [ View blame ](/pyinstaller/pyinstaller/blame/master/PyInstaller/utils/win32/winutils.py)

This file contains bidirectional Unicode text that may be interpreted or
compiled differently than what appears below. To review, open the file in an
editor that reveals hidden Unicode characters. [Learn more about bidirectional
Unicode characters](https://github.co/hiddenchars)

[ Show hidden characters ]({{ revealButtonHref }})

|
#-----------------------------------------------------------------------------  
---|---  
| # Copyright (c) 2013-2021, PyInstaller Development Team.  
| #  
| # Distributed under the terms of the GNU General Public License (version 2  
| # or later) with exception for distributing the bootloader.  
| #  
| # The full license is in the file COPYING.txt, distributed with this
software.  
| #  
| # SPDX-License-Identifier: (GPL-2.0-or-later WITH Bootloader-exception)  
|
#-----------------------------------------------------------------------------  
|  
|  
| """  
| Utils for Windows platform.  
| """  
|  
| __all__ = ['get_windows_dir']  
|  
| import os  
| import sys  
|  
| from PyInstaller import compat  
|  
| import PyInstaller.log as logging  
| logger = logging.getLogger(__name__)  
|  
|  
| def get_windows_dir():  
|  """  
|  Return the Windows directory e.g. C:\\\Windows.  
|  """  
|  # imported here to avoid circular import  
|  from PyInstaller import compat  
|  windir = compat.win32api.GetWindowsDirectory()  
|  if not windir:  
|  raise SystemExit("Error: Can not determine your Windows directory")  
|  return windir  
|  
|  
| def get_system_path():  
|  """  
|  Return the required Windows system paths.  
|  """  
|  # imported here to avoid circular import  
|  from PyInstaller import compat  
|  _bpath = []  
|  sys_dir = compat.win32api.GetSystemDirectory()  
|  # Ensure C:\Windows\system32 and C:\Windows directories are  
|  # always present in PATH variable.  
|  # C:\Windows\system32 is valid even for 64bit Windows. Access do DLLs are  
|  # transparently redirected to C:\Windows\syswow64 for 64bit applactions.  
|  # http://msdn.microsoft.com/en-us/library/aa384187(v=vs.85).aspx  
|  _bpath = [sys_dir, get_windows_dir()]  
|  return _bpath  
|  
|  
| def extend_system_path(paths):  
|  """  
|  Add new paths at the beginning of environment variable PATH.  
|  
|  Some hooks might extend PATH where PyInstaller should look for dlls.  
|  """  
|  # imported here to avoid circular import  
|  from PyInstaller import compat  
|  old_PATH = compat.getenv('PATH', '')  
|  paths.append(old_PATH)  
|  new_PATH = os.pathsep.join(paths)  
|  compat.setenv('PATH', new_PATH)  
|  
|  
| def import_pywin32_module(module_name):  
|  """  
|  Import and return the PyWin32 module with the passed name.  
|  
|  When imported, the `pywintypes` and `pythoncom` modules both internally  
|  import dynamic libraries (e.g., `pywintypes.py` imports `pywintypes34.dll`  
|  under Python 3.4). The Anaconda Python distribution for Windows installs  
|  these libraries to non-standard directories, resulting in  
|  `"ImportError: No system module 'pywintypes' (pywintypes34.dll)"`  
|  exceptions. This function catches these exceptions, searches for these  
|  libraries, adds their directories to `sys.path`, and retries.  
|  
|  Parameters  
|  \----------  
|  module_name : str  
|  Fully-qualified name of this module.  
|  
|  Returns  
|  \----------  
|  types.ModuleType  
|  The desired module.  
|  """  
|  module = None  
|  
|  try:  
|  module = __import__(  
|  module_name, globals={}, locals={}, fromlist=[''])  
|  except ImportError as exc:  
|  if str(exc).startswith('No system module'):  
|  # True if "sys.frozen" is currently set.  
|  is_sys_frozen = hasattr(sys, 'frozen')  
|  
|  # Current value of "sys.frozen" if any.  
|  sys_frozen = getattr(sys, 'frozen', None)  
|  
|  # Force PyWin32 to search "sys.path" for DLLs. By default, PyWin32  
|  # only searches "site-packages\win32\lib/", "sys.prefix", and  
|  # Windows system directories (e.g., "C:\Windows\System32"). This is  
|  # an ugly hack, but there is no other way.  
|  sys.frozen = '|_|GLYH@CK'  
|  
|  # If isolated to a venv, the preferred site.getsitepackages()  
|  # function is unreliable. Fallback to searching "sys.path" instead.  
|  if compat.is_venv:  
|  sys_paths = sys.path  
|  else:  
|  sys_paths = compat.getsitepackages()  
|  
|  for sys_path in sys_paths:  
|  # Absolute path of the directory containing PyWin32 DLLs.  
|  pywin32_dll_dir = os.path.join(sys_path, 'pywin32_system32')  
|  if os.path.isdir(pywin32_dll_dir):  
|  sys.path.append(pywin32_dll_dir)  
|  try:  
|  module = __import__(  
|  name=module_name, globals={}, locals={}, fromlist=[''])  
|  break  
|  except ImportError:  
|  pass  
|  
|  # If "sys.frozen" was previously set, restore its prior value.  
|  if is_sys_frozen:  
|  sys.frozen = sys_frozen  
|  # Else, undo this hack entirely.  
|  else:  
|  del sys.frozen  
|  
|  # If this module remains unimportable, PyWin32 is not installed. Fail.  
|  if module is None:  
|  raise  
|  
|  return module  
|  
|  
| def convert_dll_name_to_str(dll_name):  
|  """  
|  Convert dll names from 'bytes' to 'str'.  
|  
|  Latest pefile returns type 'bytes'.  
|  :param dll_name:  
|  :return:  
|  """  
|  # imported here to avoid circular import  
|  if isinstance(dll_name, bytes):  
|  return str(dll_name, encoding='UTF-8')  
|  else:  
|  return dll_name  
|  
|  
| def set_exe_checksum(exe_path):  
|  """Set executable's checksum in its metadata.  
|  
|  This optional checksum is supposed to protect the executable against  
|  corruption but some anti-viral software have taken to flagging anything  
|  without it set correctly as malware. See issue #5579.  
|  """  
|  import pefile  
|  pe = pefile.PE(exe_path)  
|  pe.OPTIONAL_HEADER.CheckSum = pe.generate_checksum()  
|  pe.close()  
|  pe.write(exe_path)  
  
  * Copy lines 
  * Copy permalink 
  * [View git blame](https://github.com/pyinstaller/pyinstaller/blame/bcb824c1ad2989855a5fc01d95e5fc693b2f0966/PyInstaller/utils/win32/winutils.py)
  * [Reference in new issue](/pyinstaller/pyinstaller/issues/new)

Go

[ ](https://github.com "GitHub") © 2022 GitHub, Inc.

### Footer navigation

  * [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
  * [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
  * [Security](https://github.com/security)
  * [Status](https://www.githubstatus.com/)
  * [Docs](https://docs.github.com)
  * [Contact GitHub](https://support.github.com?tags=dotcom-footer)
  * [Pricing](https://github.com/pricing)
  * [API](https://docs.github.com)
  * [Training](https://services.github.com)
  * [Blog](https://github.blog)
  * [About](https://github.com/about)

You can’t perform that action at this time.

You signed in with another tab or window. [Reload]() to refresh your session.
You signed out in another tab or window. [Reload]() to refresh your session.


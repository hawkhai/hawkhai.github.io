<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en" class="no-js"><head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<!-- Mobile Specific Metas  ================================================== -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<!-- CORE CONCRETE  ================================================== -->
<script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script><script type="text/javascript">var BOOTSTRAP_VERSION ="lumen";
	var BOOTSTRAP_JS_HEAD =1;
	var BOOTSTRAP_CDN_ENABLE =0; var BOOTSTRAP_NAVBAR_TYPE =0; var BOOTSTRAP_LOGO_OPTION =0; var BOOTSTRAP_NAVBAR =1; var BootstrapInputFix =true;var BootstrapNavbarLineHeightFix =true;var BOOTSTRAP_EDT= 0; </script>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>Virus Bulletin :: Through the looking glass: webcam interception and protection in kernel mode</title>
<meta name="description" content="The computer’s webcam is one of the most relevant components when it comes to digital privacy. In this paper, Reason Software's Ronen Slavin dives into the video capturing internals of Windows and discusses the implementation of a driver that protects our private snapshots before they leave the kernel mode." />
<meta name="generator" content="concrete5 - 5.6.3.5" />
<script type="text/javascript">
var CCM_DISPATCHER_FILENAME = '/index.php';
var CCM_CID = 6176;
var CCM_EDIT_MODE = false;
var CCM_ARRANGE_MODE = false;
var CCM_IMAGE_PATH = "/concrete/images";
var CCM_TOOLS_PATH = "/index.php/tools/required";
var CCM_BASE_URL = "https://www.virusbulletin.com";
var CCM_REL = "";

</script>

	<link rel="shortcut icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
	<link rel="icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="stylesheet" type="text/css" href="/concrete/css/ccm.base.css" />
<script type="text/javascript" src="/concrete/js/jquery.js"></script>
<script type="text/javascript" src="/concrete/js/ccm.base.js"></script>

<script type="text/javascript">
var COOKIES_ALLOWED=false;
</script>
<link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure.css" />
<!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure_ie.css" /><![endif]-->

<script type="text/javascript">
var COOKIES_DISCLOSURE_HIDE_INTERVAL=10;
</script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_hide.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap-overwrites.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/members.css" />
<script type="text/javascript" src="/packages/bootstrap/js/common/prettify.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/jquery.easing.1.3.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="/libraries/css/jquery.fancybox.css" />
<script type="text/javascript" src="/libraries/js/jquery.fancybox.pack.js"></script>
<link rel="stylesheet" media="screen" type="text/css" href="/files/cache/css/bootstrap/typography.css" />
<script type="text/javascript" src="/index.php/tools/packages/free_cookies_disclosure/disclosure_i18n_js"></script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_ajax_form.js"></script>
<link rel="stylesheet" type="text/css" href="/concrete/blocks/page_list/view.css" />
<link rel="stylesheet" type="text/css" href="/blocks/expand_collapse_toc/templates/vbexpand/view.css" />
<script type="text/javascript" src="/blocks/expand_collapse_toc/js/jquery.color.js"></script>
<script type="text/javascript" src="/blocks/expand_collapse_toc/js/jquery.ba-hashchange.js"></script>
<script type="text/javascript" src="/blocks/expand_collapse_toc/js/expand.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/blocks/search/templates/VB_global_search/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/travisn_spacer/css/ccm.tnspacer.css" />
<!-- added by lian to get some nice icons: -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous" />

<!-- added by lian to get syntax highlighting -->
<link rel="stylesheet" type="text/css" href="https://google-code-prettify.googlecode.com/svn/loader/prettify.css" />

<!--[if gte IE 9]>
<script src="/packages/bootstrap/js/common/modernizr.js"></script>
<![endif]-->
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>	
	
	<script src="/packages/bootstrap/js/common/html5shiv.js"></script>
	<script src="/packages/bootstrap/js/common/respond.min.js"></script>
	
<![endif]-->
<style type="text/css">.fancybox-margin{margin-right:17px;}</style></head>
<body data-spy="scroll" data-target=".bs-sidebar">

<!-- Navbar
    ================================================== -->
	<div class="navbar  navbar-fixed-top navbar-default  bs-docs-nav">
				<div class="navbar-inner">
					<div class="container"><div class="row"><div class="col-sm-4 col-md-4 logo-position-1 col-logo">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle btn_navbar_custom btn btn-default">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						  </button><div class="mobile-clearfix"></div><div class="navbar-brand navbar-brand-area"><a href="/"><img border="0" class="ccm-image-block" alt="" src="/files/4614/4535/7515/logo-big.png" width="339" height="92" /></a></div>		</div>
				</div><div class="col-sm-8 col-md-8 logo-position-1 col-nav">		<div class="nav-collapse collapse nav_collapse_custom navbar-collapse"> <div style="clear:both"></div>
<div class="vb-global-search-div"> 
<form action="/index.php/global-search-results/" method="get">
<fieldset>
	<input name="search_paths[]" type="hidden" value="" />
		<input name="query" type="text" class="vb-global-search form-control" placeholder="Search site..." />
	<input name="submit" type="submit" value="Search!" style="display:none" class="btn btn-default" />
</fieldset>
</form>
</div>


<div class="tnSpacer" style="height:48px"></div>
<ul class="nav nav-pills"><li class=" nav-first nav-item-6299"><a href="/newsletter/" target="_self" class=" nav-first nav-item-6299 ">Newsletter</a></li><li class=" nav-item-260"><a href="/conference/" target="_self" class=" nav-item-260 ">VB Conference</a></li><li class=" nav-item-166"><a href="/testing/" target="_self" class=" nav-item-166 ">VB Testing</a></li><li class=" nav-path-selected active nav-item-160"><a href="/virusbulletin/" target="_self" class=" nav-path-selected active nav-item-160 ">Bulletin</a></li><li class=" nav-last nav-item-130"><a href="/blog/" target="_self" class=" nav-last nav-item-130 ">Blog</a></li></ul> 	</div>
				</div>
			</div><div class="clearfix"></div>
        </div>
      </div>
	 
    </div>
	<div class="navbar-top-fixed-space " style="margin-top: 168px;"><div class="clearfix"></div></div>
		
<!-- Navbar
    ================================================== -->		
<div class="container m-top-20">
	<div class="row">    
		<div class="col-md-9 col-sm-9 col-lg-9">
		<h1><a class="chapter" name="h1-through-looking-glass-webcam-interception-and-protection-kernel-mode"></a>Through the looking glass: webcam interception and protection in kernel mode</h1>
<h3><a class="chapter" name="h3-ronen-slavin"></a>Ronen Slavin &amp; Michael Maltsev</h3>
<p>Reason Software, USA</p>
<p><em>Copyright © 2018 Virus Bulletin</em></p>
<hr />
<p> </p>
<div class="ccm-expand-collapse-toc">
    <div id="ccm-expand-collapse-toc-title-13076" class="ccm-expand-collapse-toc-title ccm-expand-collapse-toc-closed" data-expander-speed="500">Table of contents</div><div id="ccm-expand-collapse-toc-content-13076" class="ccm-expand-collapse-toc-content" style="height: 284px; display: none;"><p><a class="toc-level2" href="#h2-introduction">Introduction</a><br /> <a class="toc-level2" href="#h2-user-mode-video-capturing-apis">User-mode video-capturing APIs</a><br /> <a class="toc-level2" href="#h2-attack-vectors">Attack vectors</a><br /> <a class="toc-level2" href="#h2-video-capturing-kernel-mode">Video capturing in kernel mode</a><br /> <a class="toc-level2" href="#h2-camera-protection-driver-options">Camera protection driver options</a><br /> <a class="toc-level2" href="#h2-blocking-ksstate-acquire">Blocking KSSTATE_ACQUIRE</a><br /> <a class="toc-level2" href="#h2-accessing-camera-frames">Accessing the camera frames</a><br /> <a class="toc-level2" href="#h2-identifying-blocked-process">Identifying the blocked process</a><br /> <a class="toc-level2" href="#h2-conclusion">Conclusion</a><br /> <a class="toc-level2" href="#h2-acknowledgement">Acknowledgement</a><br /> <a class="toc-level2" href="#h2-references">References</a></p><p> </p></div></div>
<h2><a class="chapter" name="h2-introduction"></a>Introduction</h2>
<p>When we talk about digital privacy, the computer's webcam is one of the most relevant components. We all have a tiny fear that someone might be looking through our computer's camera, spying on us and watching our every move [<a href="#ref1">1</a>]. And while some of us think this scenario is restricted to the realm of movies, the reality is that malware authors and threat actors don't shy away from incorporating such capabilities into their malware arsenals [<a href="#ref2">2</a>].</p>
<p>Camera manufacturers protect their customers by incorporating into their devices an indicator LED that illuminates when the camera is in use. Despite the fact that a poorly designed indicator LED (implemented as a firmware function rather than as a hardware function) could allow an attacker to use the camera without turning on the indicator [<a href="#ref3">3</a>], most cameras force the illumination of the LED on a hardware level. So, are we protected by the LED indicator? Not completely. We might not notice the LED lighting up, and even if we do notice it, by that time our private snapshot is likely to have already been taken and sent to the attacker's server.</p>
<p>In this paper, our goal is to dive into the video capturing internals on <em>Windows</em>, and to implement a driver that protects our private snapshots before they leave the kernel mode.</p>
<p> </p>
<h2><a class="chapter" name="h2-user-mode-video-capturing-apis"></a>User-mode video-capturing APIs</h2>
<p>There are several user-mode image/video-capturing APIs in <em>Windows</em>, and there is plenty of information about them on the Internet [<a href="#ref4">4</a>, <a href="#ref5">5</a>]. The following are the most relevant APIs:</p>
<ul>
<li>VFW (Video for <em>Windows</em>): An obsolete technology from the Win16 era. Still available in modern <em>Windows</em> versions for legacy applications [<a href="#ref6">6</a>].</li>
<li>DirectShow: Previously part of the DirectX SDK, currently part of the Platform SDK. Probably the most popular API for interacting with the camera on <em>Windows</em>.</li>
<li>Media Foundation: Intended to replace DirectShow, but apparently is not there yet [<a href="#ref7">7</a>].</li>
</ul>
<p>Other <em>Windows</em> APIs, more relevant for scanners nowadays, are: TWAIN, a multi-platform API for scanners and cameras, and WIA (Windows Image Acquisition), which provides a still image acquisition API.</p>
<p> </p>
<h2><a class="chapter" name="h2-attack-vectors"></a>Attack vectors</h2>
<p>Let's pretend for a moment that we're the bad guys. We have gained control of a victim's computer and we can run any code on it. We would like to use his camera to get a photo or a video to use for our nefarious purposes. What are our options?</p>
<p>The simplest option is just to use one of the user-mode APIs mentioned previously. By default, <em>Windows</em> allows every app to access the computer's camera, with the exception of <em>Store</em> apps on <em>Windows 10</em>. The downside for the attackers is that camera access will turn on the indicator LED, giving the victim an indication that somebody is watching him.</p>
<p>A sneakier method is to spy on the victim when he turns on the camera himself. Patrick Wardle described a technique like this for <em>Mac</em> [<a href="#ref8">8</a>], but there's no reason the principle can't be applied to <em>Windows</em>, albeit with a slightly different implementation – e.g. we can hook into Skype and intercept its video-capturing APIs. Once the victim begins chatting via <em>Skype</em>, we'll get a peek at every frame that goes from the camera to <em>Skype</em>.</p>
<p>We can also capture the video stream in kernel mode by implementing a driver. We can even get away without having to sign it [<a href="#ref9">9</a>]. (We will see how to implement such a driver later in this paper.)</p>
<p>Other options probably exist but require advanced skills or some amount of luck, e.g., as we've already mentioned, it's sometimes possible to misuse a poorly designed camera to turn off the indicator LED.</p>
<p> </p>
<h2><a class="chapter" name="h2-video-capturing-kernel-mode"></a>Video capturing in kernel mode</h2>
<p>Unlike the user-mode APIs, there's not much information on the Internet about the kernel-mode internals of video capturing. The only places I could find relevant information were the <em>OSR Online</em> forums [<a href="#ref10">10</a>] (where Tim Roberts replied to nearly every camera-related question with extremely helpful information) and the windows‑camera-class-filter-driver <em>GitHub</em> repository [<a href="#ref11">11</a>], which implements a simple camera class filter driver. The following is a motivational quote from Tim Roberts about kernel streaming [<a href="#ref12">12</a>]: 'The exact ioctl interface to kernel streaming drivers is not documented, and it doesn't follow the rules used by other ioctls.' That's not very encouraging, but we're determined, so let's dive in.</p>
<p>From the windows-camera-class-filter-driver repository and based on other <em>OSR Online</em> posts, we learn that implementing an upper filter camera driver is the way to go. We'll use a copy of <em>Microsoft</em>'s generic toaster filter driver [<a href="#ref13">13</a>] as a starting point. Let's add some code to print every IRP (I/O request packet) that passes through our new filter driver, then install it by using the inf file from the windows‑camera-class-filter-driver repository [<a href="#ref14">14</a>]. Note that we install an upper filter driver for the 'Image' and the 'Camera' device classes. In versions of <em>Windows</em> prior to <em>Windows 10</em> version 1709, a camera device is registered under the 'Image' class, together with devices such as still‑image capture devices and scanners. <em>Windows 10</em> version 1709 added the new 'Camera' class [<a href="#ref15">15</a>] specifically for cameras.</p>
<p>You can find the source code of the driver in our <em>GitHub</em> repository [<a href="#ref16">16</a>].</p>
<p>Once we install our filter driver and restart the computer (or detach and reattach our camera), we'll be able to look at our filter driver's logs. You can attach <em>WinDbg</em> to the target computer, or use <em>DebugView</em> [<a href="#ref17">17</a>] with kernel output turned on to see the logs.</p>
<p>I ran the built-in <em>Windows Camera</em> app on <em>Windows 10</em> with the filter driver installed, then closed it and got the log output shown in [<a href="#ref81">18</a>]. There are many repeating and uninteresting IRP calls, so to save you from the boring parts, Listing 1 shows the IRPs that I found most relevant.</p>
<pre>major: IRP_MJ_CREATE filename: 5C 00 67 00 6C 00 6F 00 62 00 61 00 6C 00<br />...<br />major: IRP_MJ_CREATE filename: 7B 00 31 00 34 00 36 00 46 00 31 00 41 00 38 00 30 00 2D 00 34 00 37 00 39 00 31 00 2D 00 31 00 31 00 44 00 30 00 2D 00 41 00 35 00 44 00 36 00 2D 00 32 00 38 00 44 00 42 00 30 00 34 00 43 00 31 00 30 00 30 00 30 00 30 00 7D 00 5C 00 A0 66 87 1A CE 62 CF 11 A5 D6 28 DB 04 C1 00 00 00 00 00 00 00 00 00 00 20 B3 47 47 CE 62 CF 11 A5 D6 28 DB 04 C1 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 00 40 B0 00 00 00 00 00 00 00 00 30 2A 00 00 00 00 00 76 69 64 73 00 00 10 00 80 00 00 AA 00 38 9B 71 4D 4A 50 47 00 00 10 00 80 00 00 AA 00 38 9B 71 A0 76 2A F7 0A EB D0 11 AC E4 00 00 C0 CC 16 BA 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 8D 27 00 00 00 00 15 16 05 00 00 00 00 00 00 00 00 00 00 00 00 00 10 00 00 00 09 00 00 00 80 11 8D 00 00 00 00 00 28 00 00 00 00 05 00 00 D0 02 00 00 01 00 18 00 4D 4A 50 47 00 30 2A 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br />...<br />major: IRP_MJ_DEVICE_CONTROL ioctl: IOCTL_KS_PROPERTY request: Connection<br />KSPROPERTY_CONNECTION_STATE set type: KSSTATE_ACQUIRE<br />major: IRP_MJ_DEVICE_CONTROL ioctl: IOCTL_KS_PROPERTY request: Connection<br />KSPROPERTY_CONNECTION_STATE set type: KSSTATE_PAUSE<br />major: IRP_MJ_DEVICE_CONTROL ioctl: IOCTL_KS_PROPERTY request: Connection<br />KSPROPERTY_CONNECTION_STATE set type: KSSTATE_RUN<br />major: IRP_MJ_DEVICE_CONTROL ioctl: IOCTL_KS_READ_STREAM<br />major: IRP_MJ_DEVICE_CONTROL ioctl: IOCTL_KS_READ_STREAM<br />...<br />major: IRP_MJ_DEVICE_CONTROL ioctl: IOCTL_KS_PROPERTY request: Connection<br />KSPROPERTY_CONNECTION_STATE set type: KSSTATE_STOP<br />major: IRP_MJ_CLEANUP<br />major: IRP_MJ_CLEANUP<br />major: IRP_MJ_CLOSE<br />major: IRP_MJ_CLOSE</pre>
<p class="centered-caption">Listing 1: Most relevant IRPs.</p>
<p> </p>
<p>Unsurprisingly, it all starts with the IRP_MJ_CREATE IRP, which is sent in order to obtain a handle to the device object. In fact, our filter driver logs two IRP_MJ_CREATE IRPs with different filenames. The first IRP's filename is '\global', and the second is '{146F1A80-4791-11D0-A5D6-28DB04C10000}\...???!?!?'. Wait, what? It surprised me at first, but it turns out that this is just how the kernel streaming communication works. If the filename starts with the KSNAME_Pin GUID, it is followed by binary data which describes the communication format (compression, resolution, etc.). Note that we see two IRP_MJ_CREATE IRPs, since a kernel streaming client program opens a file handle to the device and separate file handles to each desired camera pin (one pin in our case).</p>
<p>Afterwards, we see the other IRP of great importance, IOCTL_KS_PROPERTY, specifically when used with the KSPROPERTY_CONNECTION_STATE parameter. This IRP allows the camera's streaming state to be controlled. The state can be KSSTATE_ACQUIRE, KSSTATE_PAUSE, KSSTATE_RUN or KSSTATE_STOP. The first request changes the state to KSSTATE_ACQUIRE, which causes the device to allocate the resources required for the streaming. The others are quite obvious.</p>
<p>The next interesting IRP is IOCTL_KS_READ_STREAM. While the stream is running, this IRP allows data to be read from the camera pin. This is where the actual frames with our images are flowing.</p>
<p> </p>
<h2><a class="chapter" name="h2-camera-protection-driver-options"></a>Camera protection driver options</h2>
<p>Now let's play the good guys. If we want to implement a kernel driver to defend our camera from attackers, what are our options? It looks like the most obvious option is to block IRP_MJ_CREATE. This is possible, but it may have undesired consequences, since it can also affect apps which are not actually using the camera. Here, Tim Roberts explains why trying to use a camera which is already in use by a different program fails on KSSTATE_ACQUIRE, and not earlier on IRP_MJ_CREATE:</p>
<p style="padding-left: 30px;">'At the transition to KSSTATE_ACQUIRE, the driver is supposed to fail if the hardware resources are already committed. This convention was invented during the days of Windows Media Center, because it opened an instance in a service at boot time, even if it wasn't recording anything. If drivers failed during Create, no other devices could use the camera.'</p>
<p>As you can see, every program can open a handle to the camera device without actually using it, and blocking it might break things. So if streaming takes place only on KSSTATE_ACQUIRE, we can block this instead.</p>
<p> </p>
<h2><a class="chapter" name="h2-blocking-ksstate-acquire"></a>Blocking KSSTATE_ACQUIRE</h2>
<p>This is a simple solution and it works. All we need to do is to intercept IOCTL_KS_PROPERTY and to stop it when the command KSSTATE_ACQUIRE or KSSTATE_RUN is sent. We'll reject the IRP with the STATUS_INSUFFICIENT_RESOURCES error when the KSSTATE_ACQUIRE command is sent, just as the camera does when it's already being used by a different program. We will reject KSSTATE_RUN with the STATUS_ACCESS_DENIED error just in case. You can find a POC implementation in our <em>GitHub</em> repository [<a href="#ref16">16</a>].</p>
<p>Note that the kernel streaming ioctls use the 'neither' buffering method [<a href="#ref19">19</a>], which means that what we get is raw user-mode pointers which can be accessed only from the context of the calling process. Therefore, we handle IOCTL_KS_PROPERTY in the EvtIoInCallerContext callback [<a href="#ref20">20</a>].</p>
<p>Note also that rejecting KSSTATE_ACQUIRE with STATUS_INSUFFICIENT_RESOURCES will make the program think that the camera is already being used, which is something a typical capturing program should be able to handle. We can try to use another error code, such as STATUS_ACCESS_DENIED, but then the capturing program might not be able to handle the error gracefully.</p>
<p> </p>
<h2><a class="chapter" name="h2-accessing-camera-frames"></a>Accessing the camera frames</h2>
<p>A downside to blocking the IOCTL_KS_PROPERTY IRP is that the application which is trying to use the camera receives an error, so it is likely that the attacker will guess that something is wrong and will try to find other ways to use the camera. We can use an alternative approach: we'll allow the program to start the camera streaming, but before each frame leaves the kernel mode, we'll replace it with one of our own. For example, we can send a black image or even an image of a dark room so the attacker will assume that the streaming is working, but will get nothing valuable.</p>
<p>As we already mentioned, we need to intercept IOCTL_KS_READ_STREAM in order to access/modify the camera frame. This time, we want to post-process the request, i.e. make additional changes to the data after it has been processed by the camera driver. We can do that by registering a completion routine that will be called before handing the data back to the application. We're dealing with the 'neither' buffering method, and a completion routine is not guaranteed to run in the context of the caller process, so we might not be able to use the raw user-mode pointers. Fortunately, the camera driver maps the buffers for us, so that they can be accessed from any context. We can access the header of the frame via <strong>Irp-&gt;AssociatedIrp.SystemBuffer</strong> and the frame data itself by mapping<strong> Irp-&gt;MdlAddress</strong> with <strong>MmGetSystemAddressForMdlSafe</strong>.</p>
<p>You can find a POC implementation for this technique in our <em>GitHub</em> repository [<a href="#ref16">16</a>]. Note that in my simplified implementation I merely fill the image frame buffer with zero bytes. Most camera capture programs just show a black image in this case. A more robust solution would need to send back a valid image in the correct format and resolution.</p>
<p>Note: in the 'Attack vectors' section we mentioned that we would see how to capture a camera stream in kernel mode. Just as we filled every frame with zero bytes in our example, we can read from the frame buffer and do anything we want with it.</p>
<p>A note about <strong>ksthunk</strong>: if you install the POC driver and try this protection method, you might find that it doesn't work. This can happen if you're running a 32-bit capturing program on 64-bit <em>Windows</em>. To solve this issue, there's one more little thing that we need to do: switch the loading order of our driver and the ksthunk helper driver. Ksthunk is an upper filter driver shipped with <em>Windows</em> and is designed to provide streaming compatibility for 32-bit programs on a 64-bit system. After installation, our driver ends up at the bottom of the list of upper drivers, which means that it loads last, which in turn means that it's at the top of the driver stack, i.e. it's the first filter driver to receive the incoming IRPs and the last one to post-process them. My experiments showed that sometimes ksthunk sets the <strong>Irp-&gt;MdlAddress</strong> value to zero during its post-processing. We want ksthunk to post-process the IRPs last, so that we'll get the chance to access the captured frame at <strong>Irp-&gt;MdlAddress</strong>. All we need to do is to re-order the lines in the UpperFilters registry entry (see Figures 1 and 2). Refer to the driver inf file for the full path.</p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="/files/cache/1ff59f99756da55da2949e76614ff3c6_f2958.jpg" alt="through-the-looking-glass-fig1.jpg" width="480" height="291" /> <span class="centered-caption">Figure 1: After driver installation.</span></p>
<p> </p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="/files/cache/a01398b94309bb5a669e7312ed28f88f_f2959.jpg" alt="through-the-looking-glass-fig2.jpg" width="480" height="283" /></p>
<p class="centered-caption">Figure 2: The desirable order.</p>
<p> </p>
<h2><a class="chapter" name="h2-identifying-blocked-process"></a>Identifying the blocked process</h2>
<p>What if we want to allow camera capturing for some programs but not for others? For example, it makes sense to allow <em>Skype</em> to access the camera, but not some random process which just appeared on the computer. By checking the execution context of the incoming IOCTLs, we can deduce which process sent them.</p>
<p>Unfortunately, <em>Windows 10 Anniversary Update</em> invalidates this assumption. Starting from <em>Windows 10 Anniversary Update</em>, when an application wants to capture from a camera, it doesn't talk to the device directly as it did before. Instead, it asks a service called Frame Server [<a href="#ref21">21</a>] to talk to the camera device on its behalf, acting as a proxy between the program and the device. The change was introduced to allow several programs to share the same camera concurrently, which in practice is allowed only for system services such as <em>Windows Hello</em>. Because of that, the execution context of camera-related IRPs will always be of an svchost process, which makes it impossible to distinguish the true capture program from kernel mode.</p>
<p>Identifying the relevant processes which use the camera through the Frame Server is a topic for separate research, but as a workaround, the new Frame Server can be disabled [<a href="#ref22">22</a>] by editing the registry. To disable the Frame Server globally, create the <strong>EnableFrameServerMode</strong> value of the type DWORD, and set it to zero, in the following branches:</p>
<pre>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Media Foundation\Platform</pre>
<p>And for WOW64 programs:</p>
<pre>HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows Media Foundation\Platform</pre>
<p>It can also be disabled for selected devices [<a href="#ref23">23</a>]:</p>
<p>Create the <strong>EnableDshowRedirection</strong> value of the type DWORD and set it to zero, in the following branch:</p>
<pre>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\USB\&lt;DeviceVID&amp;PID&gt;\&lt;DeviceInstance&gt;\Device Parameters</pre>
<p>And for selected programs:</p>
<p>Create the <strong>Application</strong> value of the type SZ and set it to the process file name (e.g. Skype.exe), in the following branch:</p>
<pre>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\OEM\DshowBridge\&lt;number&gt;</pre>
<p>And for WOW64 programs:</p>
<pre>HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\OEM\DshowBridge\&lt;number&gt;</pre>
<p>Note that you must verify that the process that is running is not being tampered with. For example, if you trust <em>Skype</em> blindly, an attacker could inject malicious code into <em>Skype</em> to bypass the protection, or wait for the user to start using <em>Skype</em> and capture the video frames in user mode.</p>
<p> </p>
<h2><a class="chapter" name="h2-conclusion"></a>Conclusion</h2>
<p>In this paper, we have presented possible attack vectors that involve the computer camera and our privacy, and possible ways to defend ourselves by implementing a kernel driver. Note that a properly implemented kernel driver should prevent any attempt at a user-mode attack. If the attacker is running malicious code in kernel mode, our defending kernel driver may help if the attacker is not aware of it, but it can most certainly be bypassed.</p>
<p> </p>
<h2><a class="chapter" name="h2-acknowledgement"></a>Acknowledgement</h2>
<p>Thanks to Tim Roberts for his help in reviewing this paper.</p>
<p> </p>
<h2><a class="chapter" name="h2-references"></a>References</h2>
<p><a class=" anchor" name="ref1"></a>[1] <a href="http://www.abc.net.au/triplej/programs/hack/webcam-hackers-catch-man-wanking-demand-ransom/7668434" target="_blank">http://www.abc.net.au/triplej/programs/hack/webcam-hackers-catch-man-wanking-demand-ransom/7668434</a>.</p>
<p><a class=" anchor" name="ref2"></a>[2] <a href="https://wikileaks.org/spyfiles/document/hackingteam/31_remote-control-system-v5-1/31_remote-control-system-v5-1.pdf" target="_blank">https://wikileaks.org/spyfiles/document/hackingteam/31_remote-control-system-v5-1/31_remote-control-system-v5-1.pdf</a>.</p>
<p><a class=" anchor" name="ref3"></a>[3] <a href="https://blog.erratasec.com/2013/12/how-to-disable-webcam-light-on-windows.html#.W5vPKoFtnHw" target="_blank">https://blog.erratasec.com/2013/12/how-to-disable-webcam-light-on-windows.html#.W5vPKoFtnHw</a>.</p>
<p><a class=" anchor" name="ref4"></a>[4] <a href="http://www.drdobbs.com/windows/apis-for-image-capture-applications/240156834" target="_blank">http://www.drdobbs.com/windows/apis-for-image-capture-applications/240156834</a>.</p>
<p><a class=" anchor" name="ref5"></a>[5] <a href="https://stackoverflow.com/questions/1627448/virtual-webcam-driver/1627703#1627703" target="_blank">https://stackoverflow.com/questions/1627448/virtual-webcam-driver/1627703#1627703</a>.</p>
<p><a class=" anchor" name="ref6"></a>[6] <a href="http://alax.info/blog/1633" target="_blank">http://alax.info/blog/1633</a>.</p>
<p><a class=" anchor" name="ref7"></a>[7] <a href="https://stackoverflow.com/questions/33539683/what-is-the-status-of-microsoft-media-foundation/33555619#33555619" target="_blank">https://stackoverflow.com/questions/33539683/what-is-the-status-of-microsoft-media-foundation/33555619#33555619</a>.</p>
<p><a class=" anchor" name="ref8"></a>[8] <a href="https://speakerdeck.com/patrickwardle/virusbulletin-2016-getting-duped-piggybacking-on-webcam-streams-for-surreptitious-recordings" target="_blank">https://speakerdeck.com/patrickwardle/virusbulletin-2016-getting-duped-piggybacking-on-webcam-streams-for-surreptitious-recordings</a>.</p>
<p><a class=" anchor" name="ref9"></a>[9] <a href="https://github.com/hfiref0x/TDL" target="_blank">https://github.com/hfiref0x/TDL</a>.</p>
<p><a class=" anchor" name="ref10"></a>[10] <a href="http://www.osronline.com/page.cfm?name=ListServer" target="_blank">http://www.osronline.com/page.cfm?name=ListServer</a>.</p>
<p><a class=" anchor" name="ref11"></a>[11] <a href="https://github.com/flowerinthenight/windows-camera-class-filter-driver" target="_blank">https://github.com/flowerinthenight/windows-camera-class-filter-driver</a>.</p>
<p><a class=" anchor" name="ref12"></a>[12] <a href="http://www.osronline.com/showthread.cfm?link=255336" target="_blank">http://www.osronline.com/showthread.cfm?link=255336</a>.</p>
<p><a class=" anchor" name="ref13"></a>[13] <a href="https://github.com/Microsoft/Windows-driver-samples/tree/master/general/toaster/toastDrv/kmdf/filter/generic" target="_blank">https://github.com/Microsoft/Windows-driver-samples/tree/master/general/toaster/toastDrv/kmdf/filter/generic</a>.</p>
<p><a class=" anchor" name="ref14"></a>[14] <a href="https://github.com/flowerinthenight/windows-camera-class-filter-driver/blob/master/ccfltr/ccfltr.inf" target="_blank">https://github.com/flowerinthenight/windows-camera-class-filter-driver/blob/master/ccfltr/ccfltr.inf</a>.</p>
<p><a class=" anchor" name="ref15"></a>[15] <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/stream/camera-driver-inf-file-class-setting" target="_blank">https://docs.microsoft.com/en-us/windows-hardware/drivers/stream/camera-driver-inf-file-class-setting</a>.</p>
<p><a class=" anchor" name="ref16"></a>[16] <a href="https://github.com/ReasonSoftware" target="_blank">https://github.com/ReasonSoftware</a>.</p>
<p><a class=" anchor" name="ref17"></a>[17] <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/debugview" target="_blank">https://docs.microsoft.com/en-us/sysinternals/downloads/debugview</a>.</p>
<p><a class=" anchor" name="ref81"></a>[18] <a href="https://gist.github.com/RaMMicHaeL/851fe0ceb70632cc5587c2f50bd0893d" target="_blank">https://gist.github.com/RaMMicHaeL/851fe0ceb70632cc5587c2f50bd0893d</a>.</p>
<p><a class=" anchor" name="ref19"></a>[19] <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/using-neither-buffered-nor-direct-i-o" target="_blank">https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/using-neither-buffered-nor-direct-i-o</a>.</p>
<p><a class=" anchor" name="ref20"></a>[20] <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdfdevice/nc-wdfdevice-evt_wdf_io_in_caller_context" target="_blank">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdfdevice/nc-wdfdevice-evt_wdf_io_in_caller_context</a>.</p>
<p><a class=" anchor" name="ref21"></a>[21] <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/stream/dshow-bridge-implementation-guidance-for-usb-video-class-devices" target="_blank">https://docs.microsoft.com/en-us/windows-hardware/drivers/stream/dshow-bridge-implementation-guidance-for-usb-video-class-devices</a>.</p>
<p><a class=" anchor" name="ref22"></a>[22] <a href="https://lifehacker.com/windows-10-anniversary-update-broke-millions-of-webcams-1785545990" target="_blank">https://lifehacker.com/windows-10-anniversary-update-broke-millions-of-webcams-1785545990</a>.</p>
<p><a class=" anchor" name="ref23"></a>[23] <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/stream/dshow-bridge-implementation-guidance-for-usb-video-class-devices" target="_blank">https://docs.microsoft.com/en-us/windows-hardware/drivers/stream/dshow-bridge-implementation-guidance-for-usb-video-class-devices</a>.</p>		</div>
		<div class="col-md-3 col-sm-3 col-lg-3">
		<p><a href="/uploads/pdf/magazine/2018/201809-through-the-looking-glass.pdf" target="_blank"><img src="/uploads/images/buttons/pdf-download-button.jpg" alt="Download PDF" width="262" height="45" /></a></p>
<div id="NDPHPBlock13359" class="NDPHPBlock">
<div style="width: 100%;"><div style="float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;"><center><a target="_blank" title="Tweet this!" href="https://twitter.com/share?text=Through the looking glass: webcam interception and protection in kernel mode&amp;url=https://www.virusbulletin.com/virusbulletin/2018/09/through-looking-glass-webcam-interception-and-protection-kernel-mode"><img src="/uploads/images/buttons/twitter.png" alt="twitter.png" width="45" height="45" class="responsive" /></a></center></div><div style="float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;"><center><a target="_blank" title="Share on Facebook" href="https://www.facebook.com/sharer.php?u=https://www.virusbulletin.com/virusbulletin/2018/09/through-looking-glass-webcam-interception-and-protection-kernel-mode"><img src="/uploads/images/buttons/fb.png" alt="fb.png" width="45" height="45" class="responsive" /></a></center></div><div style="float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;"><center><a target="_blank" title="Share on LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.virusbulletin.com/virusbulletin/2018/09/through-looking-glass-webcam-interception-and-protection-kernel-mode&amp;title=Through the looking glass: webcam interception and protection in kernel mode"><img src="/uploads/images/buttons/linkedin.png" alt="linkedin.png" width="45" height="45" class="responsive" /></a></center></div><div style="float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;"><center><a target="_blank" title="Share on Hacker News" href="https://news.ycombinator.com/submitlink?u=https://www.virusbulletin.com/virusbulletin/2018/09/through-looking-glass-webcam-interception-and-protection-kernel-mode&amp;t=Through the looking glass: webcam interception and protection in kernel mode"><img src="/uploads/images/buttons/hackernews.png" alt="hackernews.png" width="45" height="45" class="responsive" /></a></center></div><div style="float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;"><center><a target="_blank" title="reddit this!" href="https://www.reddit.com/submit?url=https://www.virusbulletin.com/virusbulletin/2018/09/through-looking-glass-webcam-interception-and-protection-kernel-mode"><img src="/uploads/images/buttons/reddit.png" alt="reddit.png" width="45" height="45" class="responsive" /></a></center></div></div></div><p> </p>
<h2>Latest articles:</h2>
<div class="ccm-page-list">

			<h3 class="ccm-page-list-title">
			<a href="/virusbulletin/2021/04/dissecting-design-and-vulnerabilities-azorultccpanels/" target="_self">Dissecting the design and vulnerabilities in AZORult C&amp;C panels</a>
		</h3>
		<div class="ccm-page-list-description">
			Aditya K Sood looks at the command-and-control (C&amp;C) design of the AZORult malware, discussing his team's findings related to the C&amp;C design and some security issues they identified during the research.		</div>
		
			<h3 class="ccm-page-list-title">
			<a href="/virusbulletin/2021/02/excel-formulamacro-xlsb/" target="_self">Excel Formula/Macro in .xlsb?</a>
		</h3>
		<div class="ccm-page-list-description">
			Excel Formula, or XLM – does it ever stop giving pain to researchers? Kurt Natvig takes us through his analysis of a new sample using the xlsb file format.		</div>
		
			<h3 class="ccm-page-list-title">
			<a href="/virusbulletin/2021/02/decompiling-excel-formula-xf-40-malware/" target="_self">Decompiling Excel Formula (XF) 4.0 malware</a>
		</h3>
		<div class="ccm-page-list-description">
			Office malware has been around for a long time, but until recently Excel Formula (XF) 4.0 was not something researcher Kurt Natvig was very familiar with. In this article Kurt allows us to learn with him as he takes a deeper look at XF 4.0.		</div>
		
			<h3 class="ccm-page-list-title">
			<a href="/virusbulletin/2020/10/apt-vs-internet-service-providers-threat-hunters-perspective/" target="_self">APT vs Internet service providers – a threat hunter's perspective</a>
		</h3>
		<div class="ccm-page-list-description">
			Organizations in the telecommunications sector are faced with a multitude of threats, ranging from targeted attacks to malicious actions attributable to the criminal or activist world. Telsy researcher Emanuele De Lucia reports what he observed in…		</div>
		
			<h3 class="ccm-page-list-title">
			<a href="/virusbulletin/2020/05/vb2019-paper-apt-cases-exploiting-vulnerabilities-regionspecific-software/" target="_self">VB2019 paper: APT cases exploiting vulnerabilities in region‑specific software</a>
		</h3>
		<div class="ccm-page-list-description">
			Some APT attacks are carried out by exploiting vulnerabilities in region-specific software. Government agencies frequently use such localized software, and this tends to be the target of attackers. In Japan, there have been many cases where attacks…		</div>
		
	 

	 
</div><!-- end .ccm-page-list -->


<p><br /><a class="btn btn-block btn-warning" href="/virusbulletin/archive">Bulletin Archive</a></p>		</div>
	</div>
</div>

<!-- Footer
    ================================================== -->
    <footer class="bs-footer" role="contentinfo">
      <div class="container">
        <div class="bs-social">
			<div class="row ">
						
				<div class="col-md-3">
					<p><a title="About Us" href="/about-vb/about-us/">About us</a></p>
<p><a title="Contact Us" href="/about-vb/contact-us/">Contact us</a></p>
<p><a title="Advisory Board" href="/about-vb/advisory-board/">Advisory board</a></p>
<p><a title="Press" href="/about-vb/press/">Press information</a></p>
<p><a title="Security Events Calendar" href="/resources/calendar/">Security events calendar</a></p>
<p><a title="Newsletter" href="/newsletter/">Virus Bulletin newsletter</a></p>				</div>
				<div class="col-md-3">
					<p><a title="VB Testing" href="/testing/">Testing</a></p>
<p><a title="VB100" href="/testing/vb100/">VB100</a></p>
<p><a title="VBSpam" href="/testing/vbspam/">VBSpam</a></p>
<p><a title="VBWeb" href="/testing/vbweb/">VBWeb</a></p>
<p><a title="Consultancy Services" href="/testing/consultancy-services/">Consultancy services</a></p>
<p><a title="The Spammers' Compendium" href="/resources/spammerscompendium/">Spammers' Compendium</a></p>				</div>	
									<div class="col-md-3">
					<p><a title="VB2020 localhost" href="/conference/vb2020/">VB2020 localhost</a></p>
<p><a title="VB2019" href="/conference/vb2019/">VB2019 (London)</a></p>
<p><a title="VB2018" href="/conference/vb2018">VB2018 (Montreal)</a></p>
<p><a title="VB2017" href="/conference/vb2017">VB2017 (Madrid)</a></p>
<p><a title="VB2016" href="/conference/vb2016">VB2016 (Denver)</a></p>
<p><a title="Conference Archive" href="/conference/vb-conference-archive/">Older conferences</a></p>					</div>	
				
									<div class="col-md-3">
					<div class="row">
<table style="float: right;" border="0">
<tbody>
<tr>
<td align="center"><a href="/rss" target="_blank"><img title="Get our blog updates" src="/uploads/images/buttons/rss-square-gray.png" alt="rss.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://twitter.com/virusbtn" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on Twitter" src="/uploads/images/buttons/twitter-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.linkedin.com/company/virus-bulletin" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on LinkedIn" src="/uploads/images/buttons/linkedin-square-gray.png" alt="linkedin.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.facebook.com/virusbulletin" target="_blank"><img title="Visit us on Facebook" src="/uploads/images/buttons/fb-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.youtube.com/user/virusbtn" target="_blank"><img title="Visit us on Youtube" src="/uploads/images/buttons/youtube-square-gray.png" alt="youtube.png" width="35" height="35" /></a></td>
</tr>
</tbody>
</table>
</div>					</div>	
				
								
			</div>
			<div class="row ">
				<div class="col-md-12">
									</div>							
			</div>
		</div>
      </div>
    </footer>

	<!-- lian's attempt for a new footer -->
    <footer class="bs-footer2" role="contentinfo">
      <div class="container">
        <div class="bs-social2">
			<div class="row ">
						
				<div class="col-md-3">
									</div>
				<div class="col-md-3">
									</div>	
									<div class="col-md-3">
										</div>	
				
									<div class="col-md-3">
										</div>	
				
								
			</div>
			<div class="row ">
				<div class="col-md-12">
					<p style="text-align: left;">©1989-2021 Virus Bulletin.        <a title="Privacy Policy" href="/about-vb/privacy-policy/">Privacy policy</a>        <a title="Cookies" href="/about-vb/privacy-policy/cookies/">Cookies</a>        <a title="Terms and Conditions" href="/about-vb/terms-and-conditions/">Terms and Conditions</a></p>				</div>							
			</div>
		</div>
      </div>
    </footer>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-21876594-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-21876594-2', { 'anonymize_ip': true });
</script><script type="text/javascript" src="/libraries/js/fancybox.load.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/app.js"></script>

<div id="ccm-cookiesDisclosure" class="disclosure-bottom" style="height: 181px;">
	<div class="disclosure-container">
					<div class="disclosure-content">
				<p> We have placed cookies on your device in order to improve the functionality of this site, as outlined in our <a href="/about-vb/privacy-policy/cookies" target="_blank">cookies policy</a>. However, you may delete and block all cookies from this site and your use of the site will be unaffected. By continuing to browse this site, you are agreeing to Virus Bulletin's use of data as outlined in our <a href="/about-vb/privacy-policy/" target="_blank">privacy policy</a>.</p>
			</div>
			<div class="disclosure-form">
	<form action="/index.php/cookies_disclosure/" method="POST">
					<input type="hidden" name="allowCookies" value="1" />
							<div class="button">
			<input class="btn btn-info btn-sm" type="submit" name="submit" value="I understand. Don't show this message again!" />
		</div>
	</form>
</div>
				<div class="ccm-spacer"> </div>
	</div>
</div>

<a href="#" id="toTop" class="btn btn-primary" style="display: inline;"><span id="toTopHover"></span><span class="glyphicon glyphicon-chevron-up"></span></a></body></html>
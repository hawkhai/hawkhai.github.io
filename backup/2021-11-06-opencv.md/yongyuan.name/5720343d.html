<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>Python计算机视觉编程 - 第六章 图像聚类</title>
    <meta name="description" content="Python计算机视觉编程" />
	<link rel="stylesheet" type="text/css" href="assets/css/style.css" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script type="text/javascript" src="assets/js/jquery.tableofcontents.min.js"></script>
	<script type="text/javascript" src="assets/js/global.js"></script>
</head>
<body>
	<div class="wrapper">
        <div class="header">
            <h1 class="logo"><a class="ir" href="http://yongyuan.name/pcvwithpython/">Python计算机视觉编程</a></h1>
            <p class="subtitle">Programming Computer Vision with Python</p>
        </div>


<div class="content">
	<h1>第六章 图像聚类</h1>
	<ol class="toc"></ol>

	<div class="main">
        <p>这一章会介绍几种聚类方法，并就怎么使用它们对图像进行聚类找出相似的图像组进行说明。聚类可以用于识别，划分图像数据集、组织导航等。同时，我们也会用聚类相似的图像进行可视化。</p>

<h2 id="sec-6-1">6.1 K-Means聚类</h2>

<p>K-means是一种非常简单的聚类算法，它能够将输入数据划分成k个簇。关于K-means聚类算法的介绍可以参阅中译本。</p>

<h3 id="sec-6-1-1">6.1.1 SciPy聚类包</h3>

<p>尽管K-means聚类算法很容易实现，但我们没必要自己去实现。SciPy矢量量化包sci.cluter.vq中有k-means的实现。这里我们演示怎样使用它。</p>

<p>我们以2维示例样本数据进行说明：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># coding=utf-8</span>
<span class="sd">"""</span>
<span class="sd">Function:  figure 6.1</span>
<span class="sd">    An example of k-means clustering of 2D points</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.vq</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># 添加中文字体支持</span>
<span class="kn">from</span> <span class="nn">matplotlib.font_manager</span> <span class="kn">import</span> <span class="n">FontProperties</span>
<span class="n">font</span> <span class="o">=</span> <span class="n">FontProperties</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="s">r"c:\windows\fonts\SimSun.ttc"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">class1</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">class2</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">((</span><span class="n">class1</span><span class="p">,</span> <span class="n">class2</span><span class="p">))</span>
<span class="n">centroids</span><span class="p">,</span> <span class="n">variance</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">code</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">vq</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">centroids</span><span class="p">)</span>
<span class="n">figure</span><span class="p">()</span>
<span class="n">ndx</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s">'*'</span><span class="p">)</span>
<span class="n">ndx</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s">'r.'</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">centroids</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">centroids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s">'go'</span><span class="p">)</span>

<span class="n">title</span><span class="p">(</span><span class="s">u'2维数据点聚类'</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
<span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>上面代码中where()函数给出每类的索引。运行上面代码，可得到原书P129页图6-1，即：
<img src="assets/images/figures/ch06/ch06_fig61_kmeans-2D.png" alt="ch06_fig61_kmeans-2D" /></p>

<h3 id="sec-6-1-2">6.1.2 图像聚类</h3>

<p>现在我们用k-means对原书14页的图像进行聚类，文件selectedfontimages.zip包含了66张字体图像。对于每一张图像，我们用在前40个主成分上投影后的系数作为特征向量。下面为对其进行聚类的代码：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"> <span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">PCV.tools</span> <span class="kn">import</span> <span class="n">imtools</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.vq</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">PCV.tools</span> <span class="kn">import</span> <span class="n">pca</span>

<span class="c"># Uses sparse pca codepath.</span>
<span class="n">imlist</span> <span class="o">=</span> <span class="n">imtools</span><span class="o">.</span><span class="n">get_imlist</span><span class="p">(</span><span class="s">'../data/selectedfontimages/a_selected_thumbs/'</span><span class="p">)</span>

<span class="c"># 获取图像列表和他们的尺寸</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c"># open one image to get the size</span>
<span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c"># get the size of the images</span>
<span class="n">imnbr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imlist</span><span class="p">)</span>  <span class="c"># get the number of images</span>
<span class="k">print</span> <span class="s">"The number of images is </span><span class="si">%d</span><span class="s">"</span> <span class="o">%</span> <span class="n">imnbr</span>

<span class="c"># Create matrix to store all flattened images</span>
<span class="n">immatrix</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imname</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">imname</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">],</span> <span class="s">'f'</span><span class="p">)</span>

<span class="c"># PCA降维</span>
<span class="n">V</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">immean</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">immatrix</span><span class="p">)</span>

<span class="c"># 保存均值和主成分</span>
<span class="c">#f = open('./a_pca_modes.pkl', 'wb')</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'./a_pca_modes.pkl'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">immean</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="c"># get list of images</span>
<span class="n">imlist</span> <span class="o">=</span> <span class="n">imtools</span><span class="o">.</span><span class="n">get_imlist</span><span class="p">(</span><span class="s">'../data/selectedfontimages/a_selected_thumbs/'</span><span class="p">)</span>
<span class="n">imnbr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imlist</span><span class="p">)</span>

<span class="c"># load model file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'../data/selectedfontimages/a_pca_modes.pkl'</span><span class="p">,</span><span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">immean</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="c"># create matrix to store all flattened images</span>
<span class="n">immatrix</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">im</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">],</span><span class="s">'f'</span><span class="p">)</span>

<span class="c"># project on the 40 first PCs</span>
<span class="n">immean</span> <span class="o">=</span> <span class="n">immean</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">projected</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">[:</span><span class="mi">40</span><span class="p">],</span><span class="n">immatrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">immean</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imnbr</span><span class="p">)])</span>

<span class="c"># k-means</span>
<span class="n">projected</span> <span class="o">=</span> <span class="n">whiten</span><span class="p">(</span><span class="n">projected</span><span class="p">)</span>
<span class="n">centroids</span><span class="p">,</span><span class="n">distortion</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">projected</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">code</span><span class="p">,</span><span class="n">distance</span> <span class="o">=</span> <span class="n">vq</span><span class="p">(</span><span class="n">projected</span><span class="p">,</span><span class="n">centroids</span><span class="p">)</span>

<span class="c"># plot clusters</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">code</span><span class="o">==</span><span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">figure</span><span class="p">()</span>
    <span class="n">gray</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minimum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span><span class="mi">40</span><span class="p">)):</span>
        <span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">immatrix</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">)))</span>
        <span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>运行上面代码，可得到下面的聚类结果：
<img src="assets/images/figures/ch06/2014-04-06%2012_47_22-Programming.Computer.Vision.with.Python1.pdf%20-%20Adobe%20Acrobat%20Pro.png" alt="2014-04-06 12_47_22-Programming.Computer.Vision.with.Python1.pdf - Adobe Acrobat Pro" />
注：这里的结果译者截的是原书上的结果，上面代码实际运行出来的结果可能跟上面有出入。</p>

<h3 id="sec-6-1-3">6.1.3 在主成分上可视化图像</h3>
<div class="highlight"><pre><code class="language-python" data-lang="python"> <span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">PCV.tools</span> <span class="kn">import</span> <span class="n">imtools</span><span class="p">,</span> <span class="n">pca</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">PCV.clustering</span> <span class="kn">import</span>  <span class="n">hcluster</span>

<span class="n">imlist</span> <span class="o">=</span> <span class="n">imtools</span><span class="o">.</span><span class="n">get_imlist</span><span class="p">(</span><span class="s">'../data/selectedfontimages/a_selected_thumbs'</span><span class="p">)</span>
<span class="n">imnbr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imlist</span><span class="p">)</span>

<span class="c"># Load images, run PCA.</span>
<span class="n">immatrix</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">im</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">],</span> <span class="s">'f'</span><span class="p">)</span>
<span class="n">V</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">immean</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">immatrix</span><span class="p">)</span>

<span class="c"># Project on 2 PCs.</span>
<span class="n">projected</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">immatrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">immean</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imnbr</span><span class="p">)])</span>  <span class="c"># P131 Fig6-3左图</span>
<span class="c">#projected = array([dot(V[[1, 2]], immatrix[i] - immean) for i in range(imnbr)])  # P131 Fig6-3右图</span>

<span class="c"># height and width</span>
<span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1200</span>

<span class="c"># create a new image with a white background</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
<span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="c"># draw axis</span>
<span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">((</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="c"># scale coordinates to fit</span>
<span class="n">scale</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">projected</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scaled</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">array</span><span class="p">([(</span><span class="n">p</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">projected</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c"># paste thumbnail of each image</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imnbr</span><span class="p">):</span>
  <span class="n">nodeim</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
  <span class="n">nodeim</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
  <span class="n">ns</span> <span class="o">=</span> <span class="n">nodeim</span><span class="o">.</span><span class="n">size</span>
  <span class="n">box</span> <span class="o">=</span> <span class="p">(</span><span class="n">scaled</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">scaled</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
         <span class="n">scaled</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scaled</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">img</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">nodeim</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">hcluster</span><span class="o">.</span><span class="n">hcluster</span><span class="p">(</span><span class="n">projected</span><span class="p">)</span>
<span class="n">hcluster</span><span class="o">.</span><span class="n">draw_dendrogram</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">imlist</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">'fonts.png'</span><span class="p">)</span>

<span class="n">figure</span><span class="p">()</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">'../images/ch06/pca_font.png'</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>运行上面代码，可画出原书P131图6-3中的实例结果。
<img src="assets/images/figures/ch06/ch06_fig63_kmeans_project_images.png" alt="ch06_fig63_kmeans_project_images" /></p>

<h3 id="sec-6-1-4">6.1.4 像素聚类</h3>

<p>在结束这节前，我们看一个对像素进行聚类而不是对所有的图像进行聚类的例子。将图像区域归并成“有意义的”组件称为图像分割。在第九章会将其单独列为一个主题。在像素级水平进行聚类除了可以用在一些很简单的图像，在其他图像上进行聚类是没有意义的。这里，我们将k-means应用到RGB颜色值上，关于分割问题会在第九章第二节会给出分割的方法。下面是对两幅图像进行像素聚类的例子(注：译者对原书中的代码做了调整)：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"> <span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">"""</span>
<span class="sd">Function: figure 6.4</span>
<span class="sd">    Clustering of pixels based on their color value using k-means.</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.vq</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="kn">import</span> <span class="n">imresize</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">Image</span>

<span class="c"># 添加中文字体支持</span>
<span class="kn">from</span> <span class="nn">matplotlib.font_manager</span> <span class="kn">import</span> <span class="n">FontProperties</span>
<span class="n">font</span> <span class="o">=</span> <span class="n">FontProperties</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="s">r"c:\windows\fonts\SimSun.ttc"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">clusterpixels</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">steps</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">steps</span>
    <span class="c"># compute color features for each region</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">dx</span><span class="p">:(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">dy</span><span class="p">:(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dy</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">dx</span><span class="p">:(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">dy</span><span class="p">:(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dy</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">dx</span><span class="p">:(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">dy</span><span class="p">:(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dy</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span><span class="p">])</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="s">'f'</span><span class="p">)</span>     <span class="c"># make into array</span>
    <span class="c"># 聚类， k是聚类数目</span>
    <span class="n">centroids</span><span class="p">,</span> <span class="n">variance</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">code</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">vq</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">centroids</span><span class="p">)</span>
    <span class="c"># create image with cluster labels</span>
    <span class="n">codeim</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">codeim</span> <span class="o">=</span> <span class="n">imresize</span><span class="p">(</span><span class="n">codeim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="s">'nearest'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">codeim</span>

<span class="n">k</span><span class="o">=</span><span class="mi">3</span>
<span class="n">infile_empire</span> <span class="o">=</span> <span class="s">'../data/empire.jpg'</span>
<span class="n">im_empire</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile_empire</span><span class="p">))</span>
<span class="n">infile_boy_on_hill</span> <span class="o">=</span> <span class="s">'../data/boy_on_hill.jpg'</span>
<span class="n">im_boy_on_hill</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile_boy_on_hill</span><span class="p">))</span>
<span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c"># image is divided in steps*steps region</span>
<span class="k">print</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c">#显示原图empire.jpg</span>
<span class="n">figure</span><span class="p">()</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">231</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">u'原图'</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
<span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">im_empire</span><span class="p">)</span>

<span class="c"># 用50*50的块对empire.jpg的像素进行聚类</span>
<span class="n">codeim</span><span class="o">=</span> <span class="n">clusterpixels</span><span class="p">(</span><span class="n">infile_empire</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">232</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">u'k=3,steps=50'</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
<span class="c">#ax1.set_title('Image')</span>
<span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">codeim</span><span class="p">)</span>

<span class="c"># 用100*100的块对empire.jpg的像素进行聚类</span>
<span class="n">codeim</span><span class="o">=</span> <span class="n">clusterpixels</span><span class="p">(</span><span class="n">infile_empire</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">233</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">u'k=3,steps=100'</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
<span class="c">#ax1.set_title('Image')</span>
<span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">codeim</span><span class="p">)</span>

<span class="c">#显示原图empire.jpg</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">234</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">u'原图'</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
<span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">im_boy_on_hill</span><span class="p">)</span>

<span class="c"># 用50*50的块对empire.jpg的像素进行聚类</span>
<span class="n">codeim</span><span class="o">=</span> <span class="n">clusterpixels</span><span class="p">(</span><span class="n">infile_boy_on_hill</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">235</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">u'k=3,steps=50'</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
<span class="c">#ax1.set_title('Image')</span>
<span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">codeim</span><span class="p">)</span>

<span class="c"># 用100*100的块对empire.jpg的像素进行聚类</span>
<span class="n">codeim</span><span class="o">=</span> <span class="n">clusterpixels</span><span class="p">(</span><span class="n">infile_boy_on_hill</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">236</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">u'k=3，steps=100'</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
<span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">codeim</span><span class="p">)</span>

<span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>上面代码中，先载入一幅图像，然后用一个steps*steps的方块在原图中滑动，对窗口中的图像值求和取平均，将它下采样到一个较低的分辨率，然后对这些区域用k-means进行聚类。运行上面代码，即可得出原书P133页图6-4中的图。
<img src="assets/images/figures/ch06/ch06_fig64_kmeans-pixels.png" alt="ch06_fig64_kmeans-pixels" /></p>

<h2 id="sec-6-2">6.2 层次聚类</h2>

<p>层次聚类(或称凝聚聚类)是另一种简单但有效的聚类算法。下面我们我们通过一个简单的实例看看层次聚类是怎样进行的。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span>  <span class="o">*</span>
<span class="kn">from</span> <span class="nn">PCV.clustering</span> <span class="kn">import</span> <span class="n">hcluster</span>

<span class="n">class1</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">class2</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">((</span><span class="n">class1</span><span class="p">,</span><span class="n">class2</span><span class="p">))</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">hcluster</span><span class="o">.</span><span class="n">hcluster</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="n">clusters</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">extract_clusters</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span> <span class="s">'number of clusters'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">c</span><span class="o">.</span><span class="n">get_cluster_elements</span><span class="p">()</span>
</code></pre></div>
<p>上面代码首先创建一些2维数据点，然后对这些数据点聚类，用一些阈值提取列表中的聚类后的簇群，并将它们打印出来，译者在自己的笔记本上打印出的结果为：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">number of clusters 2
[197, 107, 176, 123, 173, 189, 154, 136, 183, 113, 109, 199, 178, 129, 163, 100, 148, 111, 143, 118, 162, 169, 138, 182, 193, 116, 134, 198, 184, 181, 131, 166, 127, 185, 161, 171, 152, 157, 112, 186, 128, 156, 108, 158, 120, 174, 102, 137, 117, 194, 159, 105, 155, 132, 188, 125, 180, 151, 192, 164, 195, 126, 103, 196, 179, 146, 147, 135, 139, 110, 140, 106, 104, 115, 149, 190, 170, 172, 121, 145, 114, 150, 119, 142, 122, 144, 160, 187, 153, 167, 130, 133, 165, 191, 175, 177, 101, 141, 124, 168]
[0, 39, 32, 87, 40, 48, 28, 8, 26, 12, 94, 5, 1, 61, 24, 59, 83, 10, 99, 50, 23, 58, 51, 16, 71, 25, 11, 37, 22, 46, 60, 86, 65, 2, 21, 4, 41, 72, 80, 84, 33, 56, 75, 77, 29, 85, 93, 7, 73, 6, 82, 36, 49, 98, 79, 43, 91, 14, 47, 63, 3, 97, 35, 18, 44, 30, 13, 67, 62, 20, 57, 89, 88, 9, 54, 19, 15, 92, 38, 64, 45, 70, 52, 95, 69, 96, 42, 53, 27, 66, 90, 81, 31, 34, 74, 76, 17, 78, 55, 68]
</code></pre></div>
<h3 id="sec-6-2-1">6.2.1 图像聚类</h3>
<div class="highlight"><pre><code class="language-python" data-lang="python"> <span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">Image</span>
<span class="kn">from</span> <span class="nn">PCV.clustering</span> <span class="kn">import</span> <span class="n">hcluster</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># create a list of images</span>
<span class="n">path</span> <span class="o">=</span> <span class="s">'../data/sunsets/flickr-sunsets-small/'</span>
<span class="n">imlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.jpg'</span><span class="p">)]</span>
<span class="c"># extract feature vector (8 bins per color channel)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">imlist</span><span class="p">),</span> <span class="mi">512</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imlist</span><span class="p">):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="c"># multi-dimensional histogram</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">histogramdd</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)])</span>
    <span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">hcluster</span><span class="o">.</span><span class="n">hcluster</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

<span class="c"># visualize clusters with some (arbitrary) threshold</span>
<span class="n">clusters</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">extract_clusters</span><span class="p">(</span><span class="mf">0.23</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span>
<span class="c"># plot images for clusters with more than 3 elements</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_cluster_elements</span><span class="p">()</span>
    <span class="n">nbr_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbr_elements</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minimum</span><span class="p">(</span><span class="n">nbr_elements</span><span class="p">,</span><span class="mi">20</span><span class="p">)):</span>
            <span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imlist</span><span class="p">[</span><span class="n">elements</span><span class="p">[</span><span class="n">p</span><span class="p">]]))</span>
            <span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>

<span class="n">hcluster</span><span class="o">.</span><span class="n">draw_dendrogram</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">imlist</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">'sunset.pdf'</span><span class="p">)</span>
</code></pre></div>
<p>运行上面代码，可得原书P140图6-6。
<img src="assets/images/figures/ch06/ch06_P140-Fig6.6_02.png" alt="ch06_P140-Fig6.6_02" />
<img src="assets/images/figures/ch06/ch06_P140-Fig6.6_01.png" alt="ch06_P140-Fig6.6_01" />
同时会在上面脚本文件所在的文件夹下生成层次聚类后的簇群树：
<img src="assets/images/figures/ch06/sunset_meitu.png" alt="sunset_meitu" />
我们对前面字体图像同样创建一个树，正如前面在主成分可视化图像中，我们添加了下面代码：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">tree = hcluster.hcluster(projected)
hcluster.draw_dendrogram(tree,imlist,filename='fonts.png')
</code></pre></div>
<p>运行添加上面两行代码后前面的例子，可得对字体进行层次聚类后的簇群树：
<img src="assets/images/figures/ch06/fonts_meitu.png" alt="fonts_meitu" /></p>

<h2 id="sec-6-3">6.3 谱聚类</h2>

<p>谱聚类是另一种不同于k-means和层次聚类的聚类算法。关于谱聚类的原理，可以参阅中译本。这里，我们用原来k-means实例中用到的字体图像。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"> <span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">PCV.tools</span> <span class="kn">import</span> <span class="n">imtools</span><span class="p">,</span> <span class="n">pca</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.vq</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">imlist</span> <span class="o">=</span> <span class="n">imtools</span><span class="o">.</span><span class="n">get_imlist</span><span class="p">(</span><span class="s">'../data/selectedfontimages/a_selected_thumbs'</span><span class="p">)</span>
<span class="n">imnbr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imlist</span><span class="p">)</span>

<span class="c"># Load images, run PCA.</span>
<span class="n">immatrix</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">im</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">],</span> <span class="s">'f'</span><span class="p">)</span>
<span class="n">V</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">immean</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">immatrix</span><span class="p">)</span>

<span class="c"># Project on 2 PCs.</span>
<span class="n">projected</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">immatrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">immean</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imnbr</span><span class="p">)])</span>  <span class="c"># P131 Fig6-3左图</span>
<span class="c">#projected = array([dot(V[[1, 2]], immatrix[i] - immean) for i in range(imnbr)])  # P131 Fig6-3右图</span>

<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">projected</span><span class="p">)</span>
<span class="c"># compute distance matrix</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">array</span><span class="p">([[</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">projected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">projected</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)],</span> <span class="s">'f'</span><span class="p">)</span>
<span class="c"># create Laplacian matrix</span>
<span class="n">rowsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">rowsum</span><span class="p">))</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">identity</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">I</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">D</span><span class="p">))</span>
<span class="c"># compute eigenvectors of L</span>
<span class="n">U</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>
<span class="c"># create feature vector from k first eigenvectors</span>
<span class="c"># by stacking eigenvectors as columns</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">V</span><span class="p">[:</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="c"># k-means</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">whiten</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="n">centroids</span><span class="p">,</span><span class="n">distortion</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<span class="n">code</span><span class="p">,</span><span class="n">distance</span> <span class="o">=</span> <span class="n">vq</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="n">centroids</span><span class="p">)</span>
<span class="c"># plot clusters</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">code</span><span class="o">==</span><span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">figure</span><span class="p">()</span>
    <span class="n">gray</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minimum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span><span class="mi">39</span><span class="p">)):</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imlist</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
        <span class="n">axis</span><span class="p">(</span><span class="s">'equal'</span><span class="p">)</span>
        <span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>上面我们在前个特征向量上计算标准的k-means。下面是运行上面代码的结果：
<img src="assets/images/figures/ch06/ch06_fig6-8.png" alt="ch06_fig6-8" />
注意，由于在k-means阶段会给出不同的聚类结果，所以你运行上面代码出来的结果可能跟译者的是不一样的。</p>

<p>同样，我们可以在不知道特征向量或是没有严格相似性定义的情况下进行谱聚类。原书44页的位置地理图像是通过它们之间有多少局部描述子匹配相连接的。48页的相似性矩阵中的元素是为规范化的匹配特征点数。我们同样可以对其进行谱聚类，完整的代码如下：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"> <span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">PCV.tools</span> <span class="kn">import</span> <span class="n">imtools</span><span class="p">,</span> <span class="n">pca</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
<span class="kn">from</span> <span class="nn">PCV.localdescriptors</span> <span class="kn">import</span> <span class="n">sift</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.vq</span> <span class="kn">import</span> <span class="o">*</span>


<span class="c">#download_path = "panoimages"  # set this to the path where you downloaded the panoramio images</span>
<span class="c">#path = "/FULLPATH/panoimages/"  # path to save thumbnails (pydot needs the full system path)</span>

<span class="n">download_path</span> <span class="o">=</span> <span class="s">"F:/dropbox/Dropbox/translation/pcv-notebook/data/panoimages"</span>  <span class="c"># set this to the path where you downloaded the panoramio images</span>
<span class="n">path</span> <span class="o">=</span> <span class="s">"F:/dropbox/Dropbox/translation/pcv-notebook/data/panoimages/"</span>  <span class="c"># path to save thumbnails (pydot needs the full system path)</span>

<span class="c"># list of downloaded filenames</span>
<span class="n">imlist</span> <span class="o">=</span> <span class="n">imtools</span><span class="o">.</span><span class="n">get_imlist</span><span class="p">(</span><span class="s">'../data/panoimages/'</span><span class="p">)</span>
<span class="n">nbr_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imlist</span><span class="p">)</span>

<span class="c"># extract features</span>
<span class="c">#featlist = [imname[:-3] + 'sift' for imname in imlist]</span>
<span class="c">#for i, imname in enumerate(imlist):</span>
<span class="c">#    sift.process_image(imname, featlist[i])</span>

<span class="n">featlist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">'../data/panoimages/*.sift'</span><span class="p">)</span>

<span class="n">matchscores</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">nbr_images</span><span class="p">,</span> <span class="n">nbr_images</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbr_images</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nbr_images</span><span class="p">):</span>  <span class="c"># only compute upper triangle</span>
        <span class="k">print</span> <span class="s">'comparing '</span><span class="p">,</span> <span class="n">imlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">imlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">l1</span><span class="p">,</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">read_features_from_file</span><span class="p">(</span><span class="n">featlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">l2</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">read_features_from_file</span><span class="p">(</span><span class="n">featlist</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">match_twosided</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
        <span class="n">nbr_matches</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">matches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">'number of matches = '</span><span class="p">,</span> <span class="n">nbr_matches</span>
        <span class="n">matchscores</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbr_matches</span>
<span class="k">print</span> <span class="s">"The match scores is: </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">matchscores</span>

<span class="c"># copy values</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbr_images</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbr_images</span><span class="p">):</span>  <span class="c"># no need to copy diagonal</span>
        <span class="n">matchscores</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">matchscores</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imlist</span><span class="p">)</span>
<span class="c"># load the similarity matrix and reformat</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">matchscores</span>
<span class="n">S</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
<span class="c"># create Laplacian matrix</span>
<span class="n">rowsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">rowsum</span><span class="p">))</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">identity</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">I</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">D</span><span class="p">))</span>
<span class="c"># compute eigenvectors of L</span>
<span class="n">U</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c"># create feature vector from k first eigenvectors</span>
<span class="c"># by stacking eigenvectors as columns</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">V</span><span class="p">[:</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="c"># k-means</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">whiten</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="n">centroids</span><span class="p">,</span><span class="n">distortion</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<span class="n">code</span><span class="p">,</span><span class="n">distance</span> <span class="o">=</span> <span class="n">vq</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="n">centroids</span><span class="p">)</span>
<span class="c"># plot clusters</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">code</span><span class="o">==</span><span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">figure</span><span class="p">()</span>
    <span class="n">gray</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minimum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span><span class="mi">39</span><span class="p">)):</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imlist</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">subplot</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
        <span class="n">axis</span><span class="p">(</span><span class="s">'equal'</span><span class="p">)</span>
        <span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>改变聚类数目k，可以得到不同的结果。译者分别测试了原书中k=2和k=10的情况，运行结果如下：
<strong>k=2</strong>
<img src="assets/images/figures/ch06/ch06_fig6-9.png" alt="ch06_fig6-9" />
<strong>k=10</strong>
<img src="assets/images/figures/ch06/ch06_fig6-10.png" alt="ch06_fig6-10" />
注：对于聚类后，图像小于或等于1的类，在上面没有显示。</p>

    </div>

    <div class="navigation">
        <a class="prev_page" href=""></a>
        <a class="next_page" href=""></a>
    </div>
</div>

		<div class="footer">
                        <p>©2014 <a href="http://yuanyong.org" title="Yong Yuan 的个人网站">Yong Yuan</a> 保留部分权力。在线阅读版本基于<a href="http://creativecommons.org/licenses/by-sa/3.0/" title="Creative Commons Attribution-ShareAlike 3.0 Unported License" target="_blank">“CC 3.0 BY-SA 协议”</a>发布</p>
		</div>
	</div>



</body></html>
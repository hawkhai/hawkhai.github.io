<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn"><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="origin-when-crossorigin" />
    <meta name="description" content="众所周知，windows下可执行文件必须符合一定的格式要求，微软官方称之为PE文件（关于PE文件的详细介绍这里就不赘述了，google一下可以找到大把）；用户在界面双击exe时，有个叫做explore" />
    <meta property="og:description" content="众所周知，windows下可执行文件必须符合一定的格式要求，微软官方称之为PE文件（关于PE文件的详细介绍这里就不赘述了，google一下可以找到大把）；用户在界面双击exe时，有个叫做explore" />
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>[Rootkit] 进程隐藏 - 内存加载（寄生&amp;僵尸进程） - lyshark - 博客园</title>
    <link id="favicon" rel="shortcut icon" href="//common.cnblogs.com/favicon.svg" type="image/svg+xml" />
    
    <style>:not(.cnblogs_code):not(.cnblogs_Highlighter)&gt;pre:not([class*="language-"]):not([highlighted]):not(.hljs) {
        background: rgb(245, 247, 255);
        padding: 14px;
        border: 0px none rgb(94, 102, 135);
        border-radius: 0px;
        border-color: transparent;
        color: rgb(94, 102, 135);
        font-family: Consolas, Menlo, Monaco, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", "Courier New", Courier, monospace;
    }</style><link rel="stylesheet" href="/css/blog-common.min.css?v=Mu9uKkx5bOpY_U2n11z4SOX-euoho7tFrhfJR3pOw1Y" />
    <link id="MainCss" rel="stylesheet" href="/skins/simpleblue/bundle-simpleblue.min.css?v=FSeEa-rFf0sIksBzbHaXW8Iv0NfilAepvltZw3cr-9k" />
    <link id="highlighter-theme-prism-base16-ateliersulphurpool.light" type="text/css" rel="stylesheet" href="/css/prismjs/prism-base16-ateliersulphurpool.light.css?v=kHDZWvOQDdleGnGCsrU4mlvPUN0LuDa2i9C1cBh8jD4" />
    <link type="text/css" rel="stylesheet" href="https://www.cnblogs.com/LyShark/custom.css?v=afwUSFtghd9uL39cscvfzVAs7tk=" />
    <link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="/skins/simpleblue/bundle-simpleblue-mobile.min.css?v=rj2vgM9-SnOpGgktnrBKAhiwG7zaFNNydpmw5HBgjcQ" />
    
    <link type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/LyShark/rss" />
    <link type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/LyShark/rsd.xml" />
    <link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/LyShark/wlwmanifest.xml" />
    <script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script><script>
        var currentBlogId = 429047;
        var currentBlogApp = 'LyShark';
        var cb_enable_mathjax = false;
        var isLogined = false;
        var isBlogOwner = false;
        var skinName = 'SimpleBlue';
        var visitorUserId = '';
        var hasCustomScript = true;
        try {
            if (hasCustomScript &amp;&amp; document.referrer &amp;&amp; document.referrer.indexOf('baidu.com') &gt;= 0) {
                Object.defineProperty(document, 'referrer', { value: '' });
                Object.defineProperty(Document.prototype, 'referrer', { get: function(){ return ''; } });
            }
        } catch(error) { }
        window.codeHighlightEngine = 2;
        window.enableCodeLineNumber = false;
        window.codeHighlightTheme = 'prism-base16-ateliersulphurpool.light';
    </script>
        <script>
            var currentPostDateAdded = '2021-07-16 10:21';
        </script>
    <script src="https://common.cnblogs.com/scripts/jquery-2.2.0.min.js"></script>
    <script src="/js/blog-common.min.js?v=887Sb7P1motSoOBzgjBusvqQpRLyN2zl1Q2JIOou-CY"></script><style type="text/css">.medium-zoom-overlay{position:fixed;top:0;right:0;bottom:0;left:0;opacity:0;transition:opacity .3s;will-change:opacity}.medium-zoom--opened .medium-zoom-overlay{cursor:pointer;cursor:zoom-out;opacity:1}.medium-zoom-image{cursor:pointer;cursor:zoom-in;transition:transform .3s cubic-bezier(.2,0,.2,1)!important}.medium-zoom-image--hidden{visibility:hidden}.medium-zoom-image--opened{position:relative;cursor:pointer;cursor:zoom-out;will-change:transform}</style><script id="prismjs-script" async="" data-loaded="true" src="https://common.cnblogs.com/prism/prism.js?v=1.23.0"></script>
    
    
    
<script id="prismjs-autoloader-script" async="" data-loaded="true" src="https://common.cnblogs.com/prism/plugins/autoloader/prism-autoloader.min.js"></script></head>
<body class="skin-simpleblue no-navbar prismjs-engine">
    <a name="top"></a>
    <div id="top_nav" class="navbar forpc navbar-custom">
        <nav id="nav_main" class="navbar-main">
            <ul id="nav_left" class="navbar-list navbar-left">
                <li class="navbar-branding"><a href="https://www.cnblogs.com/" title="开发者的网上家园"><img src="/images/logo.svg?v=R9M0WmLAIPVydmdzE2keuvnjl-bPR7_35oHqtiBzGsM" alt="博客园Logo" /></a></li>
                <li><a href="/" onclick="countClicks('skin-navbar-sitehome')">首页</a></li>
                <li><a href="https://news.cnblogs.com/" onclick="countClicks('nav', 'skin-navbar-news')">新闻</a></li>
                <li><a href="https://q.cnblogs.com/" onclick="countClicks('nav', 'skin-navbar-q')">博问</a></li>
                <li><a id="nav_brandzone" href="https://brands.cnblogs.com/" onclick="countClicks('nav', 'skin-navbar-brands')">专区</a></li>
                <li><a href="https://ing.cnblogs.com/" onclick="countClicks('nav', 'skin-navbar-ing')">闪存</a></li>
                <li><a href="https://edu.cnblogs.com/" onclick="countClicks('nav', 'skin-navbar-edu')">班级</a></li>
            </ul>
            <ul id="nav_right" class="navbar-list navbar-right">
                <li>
                    <form id="zzk_search" class="navbar-search" action="https://zzk.cnblogs.com/s" method="get">
                        <input name="w" id="zzk_search_input" placeholder="代码改变世界" type="text" tabindex="3" />
                        <button type="submit" id="zzk_search_button">
                            <img src="/images/aggsite/search.svg" alt="搜索" />
                        </button>
                    </form>
                </li>
                <li id="navbar_login_status" class="navbar-list">
                    <a class="navbar-user-info navbar-blog" href="https://i.cnblogs.com/EditPosts.aspx?opt=1" alt="写随笔" title="写随笔" style="display: none;">
                        <img id="new_post_icon" class="navbar-icon" src="/images/aggsite/newpost.svg" alt="写随笔" />
                    </a>
                    <a id="navblog-myblog-icon" class="navbar-user-info navbar-blog" href="https://passport.cnblogs.com/GetBlogApplyStatus.aspx" alt="我的博客" title="我的博客" style="display: none;">
                        <img id="myblog_icon" class="navbar-icon" src="/images/aggsite/myblog.svg" alt="我的博客" />
                    </a>
                    <a class="navbar-user-info navbar-message navbar-icon-wrapper" href="https://msg.cnblogs.com/" alt="短消息" title="短消息" style="display: none;">
                        <img id="msg_icon" class="navbar-icon" src="/images/aggsite/message.svg?v=J0WS2P2iPgaIVgXxcAhliw4AFZIpaTWxtdoNAv9eiCA" alt="短消息" />
                        <span id="msg_count" style="display: none"></span>
                    </a>
                    <div id="user_info" class="navbar-user-info dropdown" style="display: none;">
                        <a class="dropdown-button" href="https://home.cnblogs.com/">
                            <img id="user_icon" class="navbar-avatar" src="/images/aggsite/avatar-default.svg" alt="用户头像" />
                        </a>
                        <div class="dropdown-menu">
                            <a id="navblog-myblog-text" href="https://passport.cnblogs.com/GetBlogApplyStatus.aspx">我的博客</a>
                            <a href="https://home.cnblogs.com/">我的园子</a>
                            <a href="https://account.cnblogs.com/settings/account">账号设置</a>
                            <a href="javascript:void(0)" id="navbar_lite_mode_toggle" title="简洁模式会使用简洁款皮肤显示所有博客">
    简洁模式 <img id="navbar_lite_mode_on" src="/images/lite-mode-check.svg" class="hide" /><span id="navbar_lite_mode_spinner" class="hide">...</span>
</a>
                            <a href="javascript:void(0)" onclick="account.logout();">退出登录</a>
                        </div>
                    </div>
                    <a class="navbar-anonymous" href="https://account.cnblogs.com/signup/" style="display: inline;">注册</a>
                    <a class="navbar-anonymous" href="javascript:void(0);" onclick="account.login()" style="display: inline;">登录</a>
                </li>
            </ul>
        </nav>
    </div>

    
    <div id="home">
    <div id="header">
        <div id="blogTitle">
            <div class="title"><a id="Header1_HeaderTitle" class="headermaintitle HeaderMainTitle" href="https://www.cnblogs.com/LyShark/">LyShark</a>
</div>
<div class="subtitle">专注于C/C++安全开发，Windows 底层技术研究</div>

        </div>
        <div id="navigator">
            
<ul id="navList">
    <li id="nav_sitehome"><a id="blog_nav_sitehome" class="menu" href="https://www.cnblogs.com/">
博客园</a>
</li>
    <li id="nav_myhome">
<a id="blog_nav_myhome" class="menu" href="https://www.cnblogs.com/LyShark/">
首页</a>
</li>
    <li id="nav_newpost">


</li>
    <li id="nav_contact">
<a id="blog_nav_contact" class="menu" href="https://msg.cnblogs.com/send/lyshark">
联系</a></li>
    <li id="nav_rss">
<a id="blog_nav_rss" class="menu" href="javascript:void(0)" data-rss="https://www.cnblogs.com/LyShark/rss/">
订阅</a></li>
    <li id="nav_admin">
<a id="blog_nav_admin" class="menu" href="https://i.cnblogs.com/">
管理</a>
</li>
</ul>

            <div class="blogStats">
                
<span id="stats_post_count">随笔 - 596 </span>
<span id="stats_article_count">文章 - 0 </span>
<span id="stats_comment_count">评论 - 9 </span>
<span id="stats_total_view_count">阅读 - 
<span title="总阅读数: 1026209">
102万</span></span>
            </div>
        </div>
    </div>
    <div id="main">
        <div id="mainContent">
            <div class="forFlow">
                <div id="post_detail">
    <div id="topics">
        <div class="post">
            <h1 class="postTitle">
                
<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/LyShark/p/15018909.html">
    <span>[Rootkit] 进程隐藏 - 内存加载（寄生&amp;僵尸进程）</span>
    



</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>众所周知，windows下可执行文件必须符合一定的格式要求，微软官方称之为PE文件（关于PE文件的详细介绍这里就不赘述了，google一下可以找到大把）；用户在界面双击exe时，有个叫做explorer的进程会监测并接受到这个事件，然后根据注册表中的信息取得文件名，再以Explorer.exe这个文件名调用CreateProcess函数去运行用户双击的exe；PC中用户一般都是这样运行exe的，所以很多用户态的exe都是exlporer的子进程。</p>
<p>用process hacker截图如下：</p>
<p><img src="https://img2020.cnblogs.com/blog/1379525/202107/1379525-20210716101745155-2038462319.png" alt="" loading="lazy" /></p>
<p>那么这个explorer究竟是怎么成功“运行”这个exe的了？这里面涉及到大量细枝末节就不深究了，本文先把主干思路捋一遍！</p>
<ul>
<li>
<p>分配内存　　<br />
既然是运行，肯定是需要放在内存的，所以首先要开辟内存空间，才能把exe从磁盘加载进来；以32位为例，由于每个进程都有自己的4GB虚拟空间，所以还涉及到新生成页表、填充CR3等琐碎的细节工作；</p>
</li>
<li>
<p>加载到内存<br />
内存分配好后，接着就该把exe从磁盘读取到内存了；</p>
</li>
<li>
<p>重定位(文章末尾有扩展，详细介绍imagebase、VA、RVA、PointerToRawData、foa等概念)<br />
这一步我个人觉得是最关键、最容易出错的了！PE文件在编译器编译的时候，编译器是不知道文件会被加载到那个VA的（一般exe默认从40000开始，这个还好；但是dll默认从100000开始，这个就不同了。一个exe一般会调用多个dll，后面加载的dll肯定会和前面加载dll的imagebase冲突），这个时候只能把dll或exe加载到其他虚拟地址；一旦改变了imagebase，涉及到地址硬编码的地方都要改了，包括：全局/静态变量、子函数调用；所以PE文件里面单独有个relc段，标明了需要重新定位和生成VA的地址；由于硬编码存放的都是相对地址，所以重定位后新VA的计算公式也很简单，</p>
</li>
<li>
<p>填写导入表<br />
一个exe的运行，很多时候要依赖操作系统提供的函数，举个最简单的例子：比如我要打印一段string，console下要用到printf或cout，MFC要用到messagebox，这些都是操作系统提供的API，编译器编译时也是不知道这些系统函数究竟被操作系统放在了内存的哪个地方，call的时候该往哪跳转了？所以只能把需要用到的这些系统函数统一放在一张叫做导入表的表格，explorer加载的时候还要挨个遍历导入表，一旦发现该PE文件用到了某些系统API，需要用这些API在内存的真实地址替换PE文件中call的地址（这也是用OD、x96dbg这些常见的调试器能找到这些系统函数的根本原因：都是系统提供的嘛，函数名必须保存起来，否则加载的时候没法替换成内存中真正的地址）！</p>
</li>
</ul>
<p>好了，到此为止exe被加载的核心步骤都缕过了；具体实现上，explorer调用了createPorcess来加载和运行exe，这就直接导致了一个后果：被任务管理器或process hacker检测到（这里和通过loadLibrary类似：只要是通过windows提供的API使用内存，都会在某些地方被记录，这也是windows常见的内存管理方式之一，用了必须记录！所以规避检测的方式之一就是自己实现exe或dll的加载和运行，不依赖window的API）！为了躲避任务管理器或process hacker的监察，只能不调用createProcess，而是自己模拟PE加载的思路重新实现一遍了（类似于自己重新openProcess函数一样吧）！</p>
<p>自己实现PE loader核心思路代码如下（参考第5个链接）：</p>
<pre class=" language-c" highlighted="true"><code class=" language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> szFileName<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"D:\\software\\PELoader-master1\\test.exe"</span><span class="token punctuation">;</span>

    <span class="token comment">//打开文件,设置属性可读可写</span>
    HANDLE hFile <span class="token operator">=</span> <span class="token function">CreateFileA</span><span class="token punctuation">(</span>szFileName<span class="token punctuation">,</span> GENERIC_READ <span class="token operator">|</span> GENERIC_WRITE<span class="token punctuation">,</span> FILE_SHARE_READ <span class="token operator">|</span> FILE_SHARE_WRITE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> OPEN_EXISTING<span class="token punctuation">,</span> FILE_ATTRIBUTE_ARCHIVE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>INVALID_HANDLE_VALUE <span class="token operator">==</span> hFile<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件打开失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取文件大小</span>
    DWORD dwFileSize <span class="token operator">=</span> <span class="token function">GetFileSize</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//申请空间</span>
    <span class="token keyword">char</span><span class="token operator">*</span> pData <span class="token operator">=</span> new <span class="token keyword">char</span><span class="token punctuation">[</span>dwFileSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"空间申请失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//将文件读取到内存中</span>
    DWORD dwRet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">ReadFile</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> pData<span class="token punctuation">,</span> dwFileSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwRet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hFile<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">//将内存中exe加载到程序中</span>
    <span class="token keyword">char</span><span class="token operator">*</span> chBaseAddress <span class="token operator">=</span> <span class="token function">RunExe</span><span class="token punctuation">(</span>pData<span class="token punctuation">,</span> dwFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>


    delete<span class="token punctuation">[</span><span class="token punctuation">]</span> pData<span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>其他代码如下（老规矩：精华都在注释了）：</p>
<pre class=" language-c" highlighted="true"><code class=" language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>


<span class="token comment">//跳转到入口点执行</span>
bool <span class="token function">CallEntry</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> chBaseAddress<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PIMAGE_DOS_HEADER pDos <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>chBaseAddress<span class="token punctuation">;</span>
    PIMAGE_NT_HEADERS pNt <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>chBaseAddress <span class="token operator">+</span> pDos<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> ExeEntry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>chBaseAddress <span class="token operator">+</span> pNt<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>AddressOfEntryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 跳转到入口点处执行</span>
    __asm
    <span class="token punctuation">{</span>
        mov eax<span class="token punctuation">,</span> ExeEntry
        jmp eax
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//设置默认加载基址</span>
bool <span class="token function">SetImageBase</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> chBaseAddress<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PIMAGE_DOS_HEADER pDos <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>chBaseAddress<span class="token punctuation">;</span>
    PIMAGE_NT_HEADERS pNt <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>chBaseAddress <span class="token operator">+</span> pDos<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pNt<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>ImageBase <span class="token operator">=</span> <span class="token punctuation">(</span>ULONG32<span class="token punctuation">)</span>chBaseAddress<span class="token punctuation">;</span>

    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//填写导入表</span>
bool <span class="token function">ImportTable</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> chBaseAddress<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PIMAGE_DOS_HEADER pDos <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>chBaseAddress<span class="token punctuation">;</span>
    PIMAGE_NT_HEADERS pNt <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>chBaseAddress <span class="token operator">+</span> pDos<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PIMAGE_IMPORT_DESCRIPTOR pImportTable <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_IMPORT_DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pDos <span class="token operator">+</span>
        pNt<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_IMPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 循环遍历DLL导入表中的DLL及获取导入表中的函数地址</span>
    <span class="token keyword">char</span><span class="token operator">*</span> lpDllName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    HMODULE hDll <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PIMAGE_THUNK_DATA lpImportNameArray <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PIMAGE_IMPORT_BY_NAME lpImportByName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PIMAGE_THUNK_DATA lpImportFuncAddrArray <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    FARPROC lpFuncAddress <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pImportTable<span class="token operator">-&gt;</span>OriginalFirstThunk<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取导入表中DLL的名称并加载DLL</span>
        lpDllName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pDos <span class="token operator">+</span> pImportTable<span class="token operator">-&gt;</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//看看这个dll是否已经加载</span>
        hDll <span class="token operator">=</span> <span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span>lpDllName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果没有加载，那么先加载到内存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> hDll<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            hDll <span class="token operator">=</span> <span class="token function">LoadLibraryA</span><span class="token punctuation">(</span>lpDllName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> hDll<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                pImportTable<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取OriginalFirstThunk以及对应的导入函数名称表首地址</span>
        lpImportNameArray <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_THUNK_DATA<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pDos <span class="token operator">+</span> pImportTable<span class="token operator">-&gt;</span>OriginalFirstThunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取FirstThunk以及对应的导入函数地址表首地址</span>
        lpImportFuncAddrArray <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_THUNK_DATA<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pDos <span class="token operator">+</span> pImportTable<span class="token operator">-&gt;</span>FirstThunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> lpImportNameArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>u1<span class="token punctuation">.</span>AddressOfData<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 获取IMAGE_IMPORT_BY_NAME结构</span>
            lpImportByName <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_IMPORT_BY_NAME<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pDos <span class="token operator">+</span> lpImportNameArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>u1<span class="token punctuation">.</span>AddressOfData<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 判断导出函数是序号导出还是函数名称导出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0x80000000</span> <span class="token operator">&amp;</span> lpImportNameArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>u1<span class="token punctuation">.</span>Ordinal<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// 序号导出</span>
                <span class="token comment">// 当IMAGE_THUNK_DATA值的最高位为1时，表示函数以序号方式输入，这时，低位被看做是一个函数序号</span>
                lpFuncAddress <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hDll<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span><span class="token punctuation">(</span>lpImportNameArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>u1<span class="token punctuation">.</span>Ordinal <span class="token operator">&amp;</span> <span class="token number">0x0000FFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// 名称导出</span>
                lpFuncAddress <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hDll<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span>lpImportByName<span class="token operator">-&gt;</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 注意此处的函数地址表的赋值，要对照PE格式进行装载，不要理解错了！！！</span>
            <span class="token comment">// 把需要调用其他dll函数的VA写回导入表，就能通过call跳转到这里执行了</span>
            lpImportFuncAddrArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>u1<span class="token punctuation">.</span>Function <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>lpFuncAddress<span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pImportTable<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>


<span class="token punctuation">}</span>


<span class="token comment">//修复重定位表</span>
bool <span class="token function">RelocationTable</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> chBaseAddress<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PIMAGE_DOS_HEADER pDos <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>chBaseAddress<span class="token punctuation">;</span>
    PIMAGE_NT_HEADERS pNt <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>chBaseAddress <span class="token operator">+</span> pDos<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PIMAGE_BASE_RELOCATION pLoc <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_BASE_RELOCATION<span class="token punctuation">)</span><span class="token punctuation">(</span>chBaseAddress <span class="token operator">+</span> pNt<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_BASERELOC<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//判断是否有重定位表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>pLoc <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>pDos<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pLoc<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> pLoc<span class="token operator">-&gt;</span>SizeOfBlock<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//开始扫描重定位表</span>
    <span class="token punctuation">{</span>
        WORD<span class="token operator">*</span> pLocData <span class="token operator">=</span> <span class="token punctuation">(</span>WORD<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pLoc <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMAGE_BASE_RELOCATION<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//计算需要修正的重定位项（地址）的数目</span>
        <span class="token keyword">int</span> nNumberOfReloc <span class="token operator">=</span> <span class="token punctuation">(</span>pLoc<span class="token operator">-&gt;</span>SizeOfBlock <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMAGE_BASE_RELOCATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>WORD<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nNumberOfReloc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pLocData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0000F000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00003000</span><span class="token punctuation">)</span> <span class="token comment">//这是一个需要修正的地址</span>
            <span class="token punctuation">{</span>
                DWORD<span class="token operator">*</span> pAddress <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pDos <span class="token operator">+</span> pLoc<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> <span class="token punctuation">(</span>pLocData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0FFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                DWORD dwDelta <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pDos <span class="token operator">-</span> pNt<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>ImageBase<span class="token punctuation">;</span><span class="token comment">//实际的imageBase减去pe文件里面标识的imagebase得到“移动的距离”</span>
                <span class="token operator">*</span>pAddress <span class="token operator">+=</span> dwDelta<span class="token punctuation">;</span><span class="token comment">//把移动的距离在原地址加上去</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//转移到下一个节进行处理</span>
        pLoc <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_BASE_RELOCATION<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pLoc <span class="token operator">+</span> pLoc<span class="token operator">-&gt;</span>SizeOfBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//将内存中的文件映射到进程内存空间中</span>
bool <span class="token function">MapFile</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> pFileBuff<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> chBaseAddress<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PIMAGE_DOS_HEADER pDos <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pFileBuff<span class="token punctuation">;</span>
    PIMAGE_NT_HEADERS pNt <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>pFileBuff <span class="token operator">+</span> pDos<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PIMAGE_SECTION_HEADER pSection <span class="token operator">=</span> <span class="token function">IMAGE_FIRST_SECTION</span><span class="token punctuation">(</span>pNt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//所有头 + 结表头的大小</span>
    DWORD dwSizeOfHeaders <span class="token operator">=</span> pNt<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>SizeOfHeaders<span class="token punctuation">;</span>

    <span class="token comment">//获取区段数量</span>
    <span class="token keyword">int</span> nNumerOfSections <span class="token operator">=</span> pNt<span class="token operator">-&gt;</span>FileHeader<span class="token punctuation">.</span>NumberOfSections<span class="token punctuation">;</span>

    <span class="token comment">// 将前一部分都拷贝过去</span>
    <span class="token function">RtlCopyMemory</span><span class="token punctuation">(</span>chBaseAddress<span class="token punctuation">,</span> pFileBuff<span class="token punctuation">,</span> dwSizeOfHeaders<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span><span class="token operator">*</span> chSrcMem <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> chDestMem <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    DWORD dwSizeOfRawData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nNumerOfSections<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pSection<span class="token operator">-&gt;</span>VirtualAddress<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pSection<span class="token operator">-&gt;</span>SizeOfRawData<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pSection<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 拷贝节区</span>
        chSrcMem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pFileBuff <span class="token operator">+</span> pSection<span class="token operator">-&gt;</span>PointerToRawData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chDestMem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>chBaseAddress <span class="token operator">+</span> pSection<span class="token operator">-&gt;</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dwSizeOfRawData <span class="token operator">=</span> pSection<span class="token operator">-&gt;</span>SizeOfRawData<span class="token punctuation">;</span>
        <span class="token function">RtlCopyMemory</span><span class="token punctuation">(</span>chDestMem<span class="token punctuation">,</span> chSrcMem<span class="token punctuation">,</span> dwSizeOfRawData<span class="token punctuation">)</span><span class="token punctuation">;</span>

        pSection<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//获取镜像大小，传入的是文件的开始地址</span>
DWORD <span class="token function">GetSizeOfImage</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> pFileBuff<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    DWORD dwSizeOfImage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    PIMAGE_DOS_HEADER pDos <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pFileBuff<span class="token punctuation">;</span>
    PIMAGE_NT_HEADERS pNt <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>pFileBuff <span class="token operator">+</span> pDos<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dwSizeOfImage <span class="token operator">=</span> pNt<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>SizeOfImage<span class="token punctuation">;</span>

    <span class="token keyword">return</span> dwSizeOfImage<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//运行文件</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">RunExe</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> pFileBuff<span class="token punctuation">,</span> DWORD dwSize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> chBaseAddress <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">//获取镜像大小</span>
    DWORD dwSizeOfImage <span class="token operator">=</span> <span class="token function">GetSizeOfImage</span><span class="token punctuation">(</span>pFileBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//根据镜像大小在进程中开辟一块内存空间</span>
    chBaseAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> dwSizeOfImage<span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> chBaseAddress<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"申请进程空间失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//将申请的进程空间全部填0</span>
    <span class="token function">RtlZeroMemory</span><span class="token punctuation">(</span>chBaseAddress<span class="token punctuation">,</span> dwSizeOfImage<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//将内存中的exe数据映射到peloader进程内存中，避免重新生成一个进程，这是隐藏exe的方式之一</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FALSE <span class="token operator">==</span> <span class="token function">MapFile</span><span class="token punctuation">(</span>pFileBuff<span class="token punctuation">,</span> chBaseAddress<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"内存映射失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//修复重定位</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FALSE <span class="token operator">==</span> <span class="token function">RelocationTable</span><span class="token punctuation">(</span>chBaseAddress<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"重定位修复失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//填写导入表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FALSE <span class="token operator">==</span> <span class="token function">ImportTable</span><span class="token punctuation">(</span>chBaseAddress<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"填写导入表失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//将页属性都设置为可读可写可执行</span>
    DWORD dwOldProtect <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FALSE <span class="token operator">==</span> <span class="token function">VirtualProtect</span><span class="token punctuation">(</span>chBaseAddress<span class="token punctuation">,</span> dwSizeOfImage<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtect<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"设置页属性失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//设置默认加载基址</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FALSE <span class="token operator">==</span> <span class="token function">SetImageBase</span><span class="token punctuation">(</span>chBaseAddress<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"设置默认加载基址失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//跳转到入口点执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FALSE <span class="token operator">==</span> <span class="token function">CallEntry</span><span class="token punctuation">(</span>chBaseAddress<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"跳转到入口点失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> chBaseAddress<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<p>从代码看：这个pe loader本质上是在loader的进程开辟空间，然后运行exe的，所以exe的代码和数据其实都在loader的空间，并未单独生成一个进程，所以任务管理器、process hacker是都查不到的！这里也是把exe想办法当成了shellcode在用！整体感觉就像“寄生”一样！</p>
<p>效果如下：单独双击运行test.exe：这就是最终呈现的效果；</p>
<p><img src="https://img2020.cnblogs.com/blog/1379525/202107/1379525-20210716101848914-1866796873.png" alt="" loading="lazy" /></p>
<p>最后，编译exe的时候出于安全考虑，建议随机基址选是，编译生成的exe每次被加载的时候imagebase都是变化的，能在一定程度上增加逆向的难度，让逆向变得很繁琐，有效消耗逆向人员的时间和精力！</p>
<p><img src="https://img2020.cnblogs.com/blog/1379525/202107/1379525-20210716101909220-1670719026.png" alt="" loading="lazy" /></p>
<p>扩展：很多小伙伴刚接触PE的时候，分不清楚imagebase、VA、RVA、PointerToRawData、foa等概念，这里来缕一缕；</p>
<p>（1）imageBase：整个文件（比如pe、sys、dll等）在虚拟内存中的起始地址；以32位为例，exe默认都是从400000开始的；OD中查询PE文件头就是imageBase；上面说的重定位也是从imageBase这里开始重新计算新地址；</p>
<p><img src="https://img2020.cnblogs.com/blog/1379525/202107/1379525-20210716101940689-616532884.png" alt="" loading="lazy" /></p>
<p>（2）virtualAddress：OD中左边的地址列就是VA，也就是在虚拟内存中的地址；</p>
<p><img src="https://img2020.cnblogs.com/blog/1379525/202107/1379525-20210716101953380-1919709086.png" alt="" loading="lazy" /></p>
<p>（3）RVA: related virtual address，翻译成中文就是相对虚拟地址；这个“相对”怎么理解了？“相对”就是VA和当前所在区段的距离；比如一个VA=0x401010，很明显是属于text段的，由于text段的基址是401000，那么这个地址的RVA=0x401010-0x401000=0x10；</p>
<p><img src="https://img2020.cnblogs.com/blog/1379525/202107/1379525-20210716102006900-1011881945.png" alt="" loading="lazy" /></p>
<p>（4）PointerToRawData：我也不知道怎么翻译成中文合适，所以干脆不翻译了；为什么会有这么一个概念了？ 或则说这个概念想表达啥了？由于历史原因，很久以前磁盘的价格是很贵的，为了节约磁盘空间，pe文件尽量“压缩”式地存放在磁盘中。为了标注各个段在磁盘中的位置，就衍生出了PointerToRawData：即磁盘中，每个段头部相对于文件开始位置的距离；当运行程序时，需要把文件加载到内存。由于采用了虚拟地址、页交换等技术，虚拟内存空间大很多，没必要“节约”着用了，为了提高cpu寻址的效率，就需要内存对齐了，直观感觉就是下图中绿色的部分；这就导致了另一个问题：同样一个段，在磁盘中相对文件起始的距离，和内存中相对imageBase的距离是不一样的（因为地址对齐，拉伸了）！ 用010editor这种软件是可以查到PointerToRawData的，如下：</p>
<p><img src="https://img2020.cnblogs.com/blog/1379525/202107/1379525-20210716102018398-1060877365.png" alt="" loading="lazy" /></p>
<p><img src="https://img2020.cnblogs.com/blog/1379525/202107/1379525-20210716102026838-466685674.png" alt="" loading="lazy" /></p>
<p>（5）FOA： file offset address，又叫file address，简称FA，也就是磁盘文件内部的地址，计算出这个地址有利于静态查找和破解打补丁（比如改if跳转逻辑）。比如我们用OD找到了一个内存虚拟地址，怎么根据这个地址在磁盘的文件中找到同样的地址了？原理很简单，如下：</p>
<p>先计算出RAV，也就是当前虚拟地址相对于所在段的距离，比如上面的0x401010-0x401000=0x10，也就是这个地址距离text段的偏移是0x10；现在问题就转换成了怎么找text段在文件中的起始地址了？也很简单，直接查PointerToRawData呗！比如这个值是0x200，那么FA=PointerToRawData+RVA=0x200+0x10=0x210！在磁盘文件内部0x210的位置就能找到了！</p>
<p><img src="https://img2020.cnblogs.com/blog/1379525/202107/1379525-20210716102039397-680914445.png" alt="" loading="lazy" /></p>

</div>
<div id="MySignature">
    <b>文章出处：</b><a href="https://www.cnblogs.com/LyShark/p/15018909.html" target="_blank">https://www.cnblogs.com/LyShark/p/15018909.html</a> <br />
<b>版权声明：</b>本博客文章与代码均为学习时整理的笔记，博客中除去明确标注有参考文献的文章，其他文章<b style="color: blue;"> [均为原创] </b>作品，转载请<b style="color: green;"> [添加出处] </b>，您添加出处是我创作的动力！<br />
<br /><b style="color:red;">如果您恶意转载本人文章并被本人发现，则您的整站文章，将会变为我的原创作品，请相互尊重 ！</b>


</div>
<div class="clear"></div>
<div id="blog_post_info_block"><div id="BlogPostCategory">
    分类: 
            <a href="https://www.cnblogs.com/LyShark/category/1221553.html" target="_blank">C/C++ 编程代码笔记</a></div>
<div id="EntryTag">
    标签: 
            <a href="https://www.cnblogs.com/LyShark/tag/C%2FC%2B%2B%20%E9%BB%91%E5%AE%A2%E7%BC%96%E7%A8%8B/">C/C++ 黑客编程</a></div>

    <div id="blog_post_info">
<div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(15018909,cb_blogId,1);green_channel_success(this,'谢谢推荐！');">好文要顶</a>
        <a id="green_channel_follow" onclick="follow('8a55a89b-7bd3-481e-d52e-08d5866282ce');" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="https://common.cnblogs.com/images/icon_weibo_24.png" alt="" /></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="https://common.cnblogs.com/images/wechat.png" alt="" /></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/LyShark/" target="_blank"><img src="https://pic.cnblogs.com/face/1379525/20211108135747.png" class="author_avatar" alt="" /></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/LyShark/">lyshark</a><br />
            <a href="https://home.cnblogs.com/u/LyShark/followees/">关注 - 2</a><br />
            <a href="https://home.cnblogs.com/u/LyShark/followers/">粉丝 - 591</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow('8a55a89b-7bd3-481e-d52e-08d5866282ce');return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(15018909,'Digg')">
        <span class="diggnum" id="digg_count">0</span>
    </div>
    <div class="buryit" onclick="votePost(15018909,'Bury')">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>

<script type="text/javascript">
    currentDiggType = 0;
</script></div>
    <div class="clear"></div>
    <div id="post_next_prev">

    <a href="https://www.cnblogs.com/LyShark/p/15018889.html" class="p_n_p_prefix">« </a> 上一篇：    <a href="https://www.cnblogs.com/LyShark/p/15018889.html" title="发布于 2021-07-16 10:17">[Rootkit] 驱动隐藏 - 断链</a>
    <br />
    <a href="https://www.cnblogs.com/LyShark/p/15019001.html" class="p_n_p_prefix">» </a> 下一篇：    <a href="https://www.cnblogs.com/LyShark/p/15019001.html" title="发布于 2021-07-16 10:37">[Rootkit] 修改 peb 隐藏 dll（断链）</a>

</div>
</div>
            </div>
            <div class="postDesc">posted @ 
<span id="post-date">2021-07-16 10:21</span> 
<a href="https://www.cnblogs.com/LyShark/">lyshark</a> 
阅读(<span id="post_view_count">168</span>) 
评论(<span id="post_comment_count">0</span>) 
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=15018909" rel="nofollow">编辑</a> 
<a href="javascript:void(0)" onclick="AddToWz(15018909);return false;">收藏</a> 
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '15018909', targetLink: 'https://www.cnblogs.com/LyShark/p/15018909.html', title: '[Rootkit] 进程隐藏 - 内存加载（寄生&amp;amp;僵尸进程）' })">举报</a></div>
        </div>
        
<script>
    markdown_highlight()
    var allowComments = true, cb_blogId = 429047, cb_blogApp = 'LyShark', cb_blogUserGuid = '8a55a89b-7bd3-481e-d52e-08d5866282ce';
    var cb_entryId = 15018909, cb_entryCreatedDate = '2021-07-16 10:21', cb_postType = 1;
    updatePostStats(
        [cb_entryId],
        function(id, count) { $("#post_view_count").text(count) },
        function(id, count) { $("#post_comment_count").text(count) })
    zoomManager.apply("#cnblogs_post_body img:not(.code_img_closed):not(.code_img_opened)");
</script>
        <a name="!comments"></a>
<div id="blog-comments-placeholder"></div>
<div id="comment_form" class="commentform">
    <a name="commentform"></a>
    <div id="divCommentShow"></div>
    <div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
    <div id="comment_form_container" style="visibility: visible;"><div class="login_tips">
    登录后才能查看或发表评论，立即 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return account.login('!comments');">登录</a> 或者
    <a href="https://www.cnblogs.com/">逛逛</a> 博客园首页
</div>
</div>
    <div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
    <div id="cnblogs_ch"><a href="https://brands.cnblogs.com/huawei" target="_blank" onclick="gtag('event', 'click', {'event_category': 'ad', 'event_label': 'T2-华为专区'})">【推荐】华为开发者专区，与开发者一起构建万物互联的智能世界</a><br /><a href="http://www.uccpsoft.com/index.htm" target="_blank" onclick="gtag('event', 'click', {'event_category': 'ad', 'event_label': 'T2-ucancode'})">【推荐】跨平台组态\工控\仿真\CAD 50万行C++源码全开放免费下载！</a><br /><a href="https://brands.cnblogs.com/huawei/p/2749" target="_blank" onclick="gtag('event', 'click', {'event_category': 'ad', 'event_label': 'T2-华为专区'})">【推荐】华为 HMS Core Insights 直播预告：手语服务，助力沟通无障碍</a><br /></div>
    <div id="opt_under_post"></div>
    <div id="cnblogs_c1" class="under-post-card">
            <a href="https://campaign.tencent.com/audiovideo/?c=1ykYj45F" rel="nofollow" target="_blank" onclick="logCreativeClick(504);countCreativeClicks('C1-腾讯云')">
                <img src="https://img2020.cnblogs.com/blog/35695/202112/35695-20211222111937217-1095539880.jpg" onload="logCreativeImpression(504);countCreativeImpressions('C1-腾讯云')" alt="" />
            </a>
    </div>
    <div id="under_post_card1"></div>
    <div id="under_post_card2"></div>
    <div id="HistoryToday" class="under-post-card">
<b>历史上的今天：</b>
<br />

2019-07-16    <a href="https://www.cnblogs.com/LyShark/p/11197005.html">X86逆向15：OD脚本的编写技巧</a>
    <br />
</div>
    <script type="text/javascript">
       var commentManager = new blogCommentManager();
       commentManager.renderComments(0);
       fixPostBody();

           window.tocManager.displayDisableTocTips = false
           window.tocManager.generateToc();
           setTimeout(function() { incrementViewCount(cb_entryId); }, 50);       deliverT2();
       deliverC1C2();
       loadNewsAndKb();
LoadPostCategoriesTags(cb_blogId, cb_entryId);       LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
       GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
       loadOptUnderPost();
       GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
    </script>
</div>

    </div>
</div>
            </div>
        </div>

        <div id="sideBar">
            <div id="sideBarMain">
                <div id="sidebar_news" class="newsItem">
<h3 class="catListTitle">公告</h3>

<div id="blog-news">
    <center>
    个人博客: <span style="color: #399ab2;"><a href="https://www.lyshark.com">www.lyshark.com</a></span><br />
<hr style="height:1px;border:none;border-top:1px solid #555555;" />
    <span id="busuanzi_container_site_pv" style="display: inline;">访问量: <span style="color: #399ab2;" id="busuanzi_value_site_pv">4131508</span></span> | 
    <span id="busuanzi_container_site_uv" style="display: inline;">访客数: <span style="color: #399ab2;" id="busuanzi_value_site_uv">3296480</span></span><br />
<hr style="height:1px;border:none;border-top:1px solid #555555;" />
</center>

<script type="text/javascript">window['__document_write_ajax_callbacks__']['3']();</script><script type="text/javascript">window['__document_write_ajax_callbacks__']['4']();</script><script language="javascript" type="text/javascript" async="">window['__document_write_ajax_callbacks__']['1']();</script>
    <div id="profile_block">
        昵称：
        <a href="https://home.cnblogs.com/u/LyShark/">
            lyshark
        </a>
        <br />
        园龄：
        <a href="https://home.cnblogs.com/u/LyShark/" title="入园时间：2018-04-18">
            3年8个月
        </a>
        <br />
        粉丝：
        <a href="https://home.cnblogs.com/u/LyShark/followers/">
            591
        </a>
        <br />
        关注：
        <a href="https://home.cnblogs.com/u/LyShark/followees/">
            2
        </a>
        <div id="p_b_follow">
<a href="javascript:void(0)" onclick="follow('8a55a89b-7bd3-481e-d52e-08d5866282ce')">+加关注</a></div>
        <script type="text/javascript">window['__document_write_ajax_callbacks__']['5']();</script><script>window['__document_write_ajax_callbacks__']['2']();</script>
    </div>
</div></div>
<div id="sidebar_c3"></div>
                <div id="calendar"><div id="blog-calendar" style="display:none"></div></div>                
                <script>loadBlogDefaultCalendar();</script>
                <div id="leftcontentcontainer">
                    <!-- begin:SingleColumn -->
                    <div id="blog-sidecolumn"><!-- 搜索 -->
<div id="sidebar_search" class="sidebar-block">
    <div id="sidebar_search" class="mySearch">
        <h3 class="catListTitle">搜索</h3>
        <div id="sidebar_search_box">
            <div id="widget_my_zzk" class="div_my_zzk">
                <input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk" /> <input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk" />
            </div>
            
        </div>
    </div>
</div>

<!-- 常用链接 -->


<!-- 最新随笔 -->


<!-- 我的标签 -->
<div id="sidebar_toptags" class="sidebar-block">
<div class="catListTag">
    <h3 class="catListTitle">我的标签</h3>
    <ul>
                <li>
            <a href="https://www.cnblogs.com/LyShark/tag/C%2FC%2B%2B%20%E9%BB%91%E5%AE%A2%E7%BC%96%E7%A8%8B/">C/C++ 黑客编程<span class="tag-count">(96)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/LyShark/tag/%E6%B8%97%E9%80%8F%E4%B8%8E%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">渗透与网络安全<span class="tag-count">(48)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/LyShark/tag/Python%20%E9%BB%91%E5%AE%A2%E7%BC%96%E7%A8%8B/">Python 黑客编程<span class="tag-count">(28)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/LyShark/tag/%E6%B8%B8%E6%88%8F%E5%A4%96%E6%8C%82%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF/">游戏外挂开发技术<span class="tag-count">(27)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/LyShark/tag/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E6%8A%80%E6%9C%AF/">软件逆向破解技术<span class="tag-count">(26)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/LyShark/tag/%E6%B1%87%E7%BC%96%E4%B8%8E%E5%8F%8D%E6%B1%87%E7%BC%96%E6%8A%80%E6%9C%AF/">汇编与反汇编技术<span class="tag-count">(20)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/LyShark/tag/Windows%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B/">Windows 内核编程<span class="tag-count">(11)</span></a>
        </li>
    

    </ul>
</div>
</div>

<!-- 积分与排名 -->
<div id="sidebar_scorerank" class="sidebar-block">
<div class="catListBlogRank">
    <h3 class="catListTitle">积分与排名</h3>
    <ul>
        <li class="liScore">
            积分 - 
512683
        </li>
        <li class="liRank">
            排名 - 
951
        </li>
    </ul>
</div></div>

<!-- 随笔分类、随笔档案、文章分类、新闻分类、相册、链接 -->
<div id="sidebar_categories">

    <div class="catListPostCategory">
        <h3 class="catListTitle">
            
随笔分类



        </h3>
        <ul>
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2038070.html" class="category-item-link" rel="" target="">Ansible 自动化使用笔记(7)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2038133.html" class="category-item-link" rel="" target="">C/C++ Boost 开发笔记(8)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2038135.html" class="category-item-link" rel="" target="">C/C++ Qt 窗体开发笔记(37)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1221553.html" class="category-item-link" rel="" target="">C/C++ 编程代码笔记(125)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2038134.html" class="category-item-link" rel="" target="">C/C++ 基础知识点总结(16)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2038036.html" class="category-item-link" rel="" target="">Django Web 框架笔记(20)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2038069.html" class="category-item-link" rel="" target="">Docker 容器使用笔记(7)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2038132.html" class="category-item-link" rel="" target="">Flask Web 框架笔记(8)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1219787.html" class="category-item-link" rel="" target="">Linux 服务配置学习笔记(46)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1340048.html" class="category-item-link" rel="" target="">Linux 系统使用学习笔记(27)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2038071.html" class="category-item-link" rel="" target="">PHP 安全开发笔记(10)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1219800.html" class="category-item-link" rel="" target="">Python 编程笔记(39)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2038873.html" class="category-item-link" rel="" target="">Python 黑客编程(18)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1789194.html" class="category-item-link" rel="" target="">Visual C# 开发笔记(12)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1496783.html" class="category-item-link" rel="" target="">Web 前端开发笔记(14)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1496909.html" class="category-item-link" rel="" target="">Win32 内核编程笔记(11)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1466600.html" class="category-item-link" rel="" target="">动手写操作系统(1)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1496795.html" class="category-item-link" rel="" target="">汇编与反汇编笔记(20)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1374452.html" class="category-item-link" rel="" target="">软件逆向分析教程(27)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1339134.html" class="category-item-link" rel="" target="">渗透与网络安全笔记(58)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1231445.html" class="category-item-link" rel="" target="">数据库使用笔记(26)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1496792.html" class="category-item-link" rel="" target="">网络设备配置笔记(9)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2010120.html" class="category-item-link" rel="" target="">我的安全工具发布(5)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1496775.html" class="category-item-link" rel="" target="">游戏逆向分析教程(27)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/1923803.html" class="category-item-link" rel="" target="">运维故障处理(4)</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/LyShark/category/2009969.html" class="category-item-link" rel="" target="">转载与收藏(17)</a>

                    
                </li>
                                        
        </ul>
    </div>    <div class="catList">
        <h3 class="catListTitle">
            
友情链接



        </h3>
        <ul>
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://hackergu.com/" class="category-item-link" rel="nofollow noopener noreferrer" target="_blank">HackerGu</a>

                    
                </li>
                                            <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://blog.linux-code.com/" class="category-item-link" rel="nofollow noopener noreferrer" target="_blank">北慕城南</a>

                    
                </li>
                                        
        </ul>
    </div></div>

<!-- 最新评论 -->



<!-- 阅读排行榜 -->


<!-- 评论排行榜 -->


<!-- 推荐排行榜 -->
</div>
                    <script>loadBlogSideColumn();</script>
                    <!-- end:  SingleColumn -->
                </div>
            </div>
        </div>
        <div class="clear"></div>
    </div>
    <div class="clear"></div>
    <div id="footer">
        <!--done-->
Copyright © 2021 lyshark
<br /><span id="poweredby">Powered by .NET 6 on Kubernetes</span>

    </div>
</div>

    <div id="page_end_html">
        <script language="javascript" type="text/javascript">
function GenerateContentList()
{
    var jquery_h3_list = $('#cnblogs_post_body h3');
    if(jquery_h3_list.length&gt;0)
    {
        var content = '&lt;a rel="nofollow"  name="_labelTop"&gt;&lt;/a&gt;';
        content    += '&lt;div id="navCategory"&gt;';
        content    += '&lt;p style="font-size:18px"&gt;&lt;b&gt;文章阅读目录&lt;/b&gt;&lt;/p&gt;';
        content    += '&lt;ul&gt;';
        for(var i =0;i&lt;jquery_h3_list.length;i++)
        {
            var go_to_top = '&lt;div style="text-align: right"&gt;&lt;a rel="nofollow"  href="#_labelTop"&gt;回到顶部&lt;/a&gt;&lt;a rel="nofollow"  name="_label' + i + '"&gt;&lt;/a&gt;&lt;/div&gt;';
            $(jquery_h3_list[i]).before(go_to_top);
            var li_content = '&lt;li&gt;&lt;a rel="nofollow"  href="#_label' + i + '"&gt;' + $(jquery_h3_list[i]).text() + '&lt;/a&gt;&lt;/li&gt;';
            content += li_content;
        }
        content    += '&lt;/ul&gt;';
        content    += '&lt;/div&gt;';
        if($('#cnblogs_post_body').length != 0 )
        {
            $($('#cnblogs_post_body')[0]).prepend(content);
        }
    }
}
GenerateContentList();
</script>
<div style="display:none;">
<script type="text/javascript" src="https://s4.cnzz.com/z_stat.php?id=1280731970&amp;web_id=1280731970"></script><script src="https://c.cnzz.com/core.php?web_id=1280731970&amp;t=z" charset="utf-8" type="text/javascript"></script><a href="https://www.cnzz.com/stat/website.php?web_id=1280731970" target="_blank" title="站长统计">站长统计</a>
</div>
    </div>

    <input type="hidden" id="antiforgery_token" value="CfDJ8GsLOKiGtk1Au0UP1SouGdVJPoKCSNzKkGjtrBgBKMSAcY36kNNgZpEtDuxG6WO36Bvfb1DkbHRmcE0jBe9O9R6CJb-MNXAA8Q-G5mLpWwPgpxaWDPSxTS9X1n4r7zCe6-CrFCTCE7N2yrlsevuyuEs" />
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-476124-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    var kv = getGACustom();
    if (kv) {
        gtag('set', kv);
    }
    gtag('config', 'UA-476124-1');
    </script>
    <script defer="" src="https://hm.baidu.com/hm.js?866c9be12d4a814454792b1fd0fed295"></script>

<script type="text/javascript">getFollowStatus('8a55a89b-7bd3-481e-d52e-08d5866282ce');</script></body></html>
---
layout: post
title: "图形学笔记 -- GAMES101: 现代计算机图形学入门（光线追踪和动画）"
author:
location: "珠海"
categories: ["图形学"]
tags: ["图形学", "OpenGL"]
toc: true
toclistyle: none
comments:
visibility:
mathjax: true
mermaid:
glslcanvas:
codeprint:
cluster: "GAMES101 - 现代计算机图形学入门 - 闫令琪"
---

* <https://mathpix.com/>
* [GAMES101: 现代计算机图形学入门](https://sites.cs.ucsb.edu/~lingqi/teaching/games101.html)
* [GAMES202: 高质量实时渲染](https://sites.cs.ucsb.edu/~lingqi/teaching/games202.html)
* [GAMES101-现代计算机图形学入门-闫令琪 {% include relref_bili.html %}](https://www.bilibili.com/video/BV1X7411F744)


## 十三、光线追踪（基本原理）Ray Tracing

* Whitted-Style Ray Tracing

{% include image.html url="/assets/images/210801-games101-rt/20210801001203.png" caption="Why Ray Tracing?" %}

**Light Rays**
Three ideas about light rays
1. Light travels in straight lines (though this is wrong) 直线
2. Light rays do not “collide” with each other if they cross (though this is still wrong) 不碰撞
3. Light rays travel from the light sources to the eye
    (but the physics is invariant under path reversal - reciprocity). 可逆性

“And if you gaze long into an abyss, the abyss also gazes
into you.” — Friedrich Wilhelm Nietzsche (translated)

求射线和一个平面的交点？一个重心坐标，搞定，真的是神奇哦。
{% include image.html url="/assets/images/210801-games101-rt/20210801005926.png" caption="Möller Trumbore Algorithm" %}

Axis-Aligned
Bounding Box (AABB)
（轴对齐包围盒）

- The ray enters the box only when it enters all pairs of slabs
- The ray exits the box as long as it exits any pair of slabs
- For the 3D box, tenter = max{tmin}, texit = min{tmax}


## 十四、光线追踪（加速结构）

Uniform Spatial Partitions (Grids)

{% include image.html url="/assets/images/210801-games101-rt/20210801020009.png" caption="Spatial Partitioning Examples" %}

**Data Structure for KD-Trees**

Internal nodes store
* split axis: x-, y-, or z-axis
* split position: coordinate of split plane along axis
* children: pointers to child nodes
* No objects are stored in internal nodes
Leaf nodes store
* list of objects

Bounding Volume Hierarchy (BVH)
[快速选择算法 {% include relref_csdn.html %}](https://blog.csdn.net/qq_40692109/article/details/102696615) 其时间复杂度可以达到 $$O(n)$$。
网页里面的代码存在 bug，稍微改了改。^_^

{% include image.html url="/assets/images/210801-games101-rt/20191023112356434.png" %}

```cpp
#include "stdafx.h"
#include <assert.h>

template<typename T>
void qSwap(T arr[], int x, int y) {
    if (x == y) return;
    T temp = arr[x];
    arr[x] = arr[y];
    arr[y] = temp;
}

template<typename T>
void qDebug(T arr[], int low, int high, int k, int size) {
    printf("%d %d %d - ", low, high, k);
    for (int i = 0; i < size; i++) {
        printf(i == low ? "[" : " ");
        printf("%d", arr[i]);
        printf(i == high ? "]" : " ");
    }
    printf("\n");
}

// 在选出第 K 大的元素之后，我们也自然有了前 K 大的数，
// 因为在 K 右边的数都是比 K 大的，在 K 左边的数都是比 K 小的。
template<typename T>
T qSelect(T arr[], int low, int high, int k, int size) {
    qDebug(arr, low, high, k, size);
    if (low >= high) {
        assert(k == low); // 断言断的是我们的代码没有 bug。
        return arr[low];
    }
    int left = low;
    int right = high + 1;
    int key = arr[low];
    while (true) {
        /* 从左向右找比 key 大的值 */
        while (arr[++left] < key) {
            if (left == high) {
                break;
            }
        }
        /* 从右向左找比 key 小的值 */
        while (arr[--right] > key) {
            if (right == low) {
                break;
            }
        }
        if (left >= right) break;
        /* 交换 left, right 对应的值 */
        qSwap(arr, left, right);
    }
    /* 中枢值与 right 对应值交换 */
    assert(arr[right] <= key);
    // 左边都是比 key 小等的，右边都是比 key 大等的。
    qSwap(arr, low, right);
    // 从小到大排序的第 k 个元素。
    if (right > k) {
        return qSelect(arr, low, right - 1, k, size);
    }
    else if (right < k) {
        return qSelect(arr, right + 1, high, k, size);
    }
    else {
        return arr[right];
    }
}

int compare(const void* a, const void* b) {
    return (*(int*)a - *(int*)b);
}

int* genArray(int size) {
    int* ali = new int[size];
    for (int i = 0; i < size; i++) {
        ali[i] = abs(rand()) % 10 + 1;
    }
    return ali;
}

void freeArray(int* ali) {
    delete[] ali;
}

int maintest() {
    int size = abs(rand()) % 8 + 1;
    int* ali = genArray(size);

    int k = abs(rand()) % size;
    int result = qSelect(ali, 0, size - 1, k, size);
    qsort(ali, size, sizeof(int), compare);
    if (result != ali[k]) {
        assert(result == ali[k]);
    }
    freeArray(ali);
    printf("result - %d \n", result);
    return 0;
}

int _tmain(int argc, _TCHAR* argv[])
{
    for (int i = 0; i < 10000; i++) {
        maintest();
    }
    return 0;
}
```

跑出来的示例：
```
0 1 0 - [8  5]
0 0 0 - [5] 8
result - 5
0 1 0 - [5  9]
result - 5
0 2 1 - [5  6  6]
1 2 1 -  5 [6  6]
1 1 1 -  5 [6] 6
result - 6
0 3 3 - [2  2  6  3]
2 3 3 -  2  2 [6  3]
result - 6
0 4 2 - [2  5  3  4  3]
1 4 2 -  2 [5  3  4  3]
1 3 2 -  2 [3  3  4] 5
result - 3
0 5 0 - [7  9  6  8  7  2]
0 2 0 - [7  2  6] 7  8  9
0 1 0 - [6  2] 7  7  8  9
0 0 0 - [2] 6  7  7  8  9
result - 2
0 5 3 - [3  8  10  6  5  4]
1 5 3 -  3 [8  10  6  5  4]
1 3 3 -  3 [5  4  6] 8  10
3 3 3 -  3  4  5 [6] 8  10
result - 6
0 2 0 - [4  4  5]
0 0 0 - [4] 4  5
result - 4
0 7 3 - [4  9  8  5  3  8  8  10]
2 7 3 -  3  4 [8  5  9  8  8  10]
2 4 3 -  3  4 [8  5  8] 8  9  10
2 3 3 -  3  4 [8  5] 8  8  9  10
result - 8
0 5 0 - [10  9  7  6  1  3]
0 4 0 - [3  9  7  6  1] 10
0 0 0 - [1] 3  7  6  9  10
result - 1
```

52:43

<hr class='reviewline'/>
<p class='reviewtip'><script type='text/javascript' src='{% include relref.html url="/assets/reviewjs/blogs/2021-08-01-games101-rt.md.js" %}'></script></p>
<font class='ref_snapshot'>参考资料快照</font>

- [https://mathpix.com/]({% include relrefx.html url="/backup/2021-08-01-games101-rt.md/mathpix.com/6a3d6789.html" %})
- [https://sites.cs.ucsb.edu/~lingqi/teaching/games101.html]({% include relrefx.html url="/backup/2021-08-01-games101-rt.md/sites.cs.ucsb.edu/066e265f.html" %})
- [https://sites.cs.ucsb.edu/~lingqi/teaching/games202.html]({% include relrefx.html url="/backup/2021-08-01-games101-rt.md/sites.cs.ucsb.edu/c77d447b.html" %})
- [https://www.bilibili.com/video/BV1X7411F744]({% include relrefx.html url="/backup/2021-08-01-games101-rt.md/www.bilibili.com/99e29ea3.html" %})
- [https://blog.csdn.net/qq_40692109/article/details/102696615]({% include relrefx.html url="/backup/2021-08-01-games101-rt.md/blog.csdn.net/5c71cab3.html" %})
